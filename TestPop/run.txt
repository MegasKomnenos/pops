while = {
	count = 100
	
	modi_refresh = yes
	
	prod_update_instances = yes
	
	every_in_global_list = {
		variable = prod_instances
		
		if = {
			limit = {
				OR = {
					NOT = {
						has_variable = prod_size
					}
					
					var:prod_size < 0.01
				}
			}
			if = {
				limit = {
					has_variable = prod_pop_1
				}
				remove_variable = prod_pop_1
				
				prod_pop_instance = yes
			}
			else_if = {
				limit = {
					has_variable = prod_pop_0
				}
				remove_variable = prod_pop_0
				
				set_variable = { name = prod_pop_1 }
			}
			else = {
				set_variable = { name = prod_pop_0 }
			}
		}
		else = {
			remove_variable = prod_pop_0
			remove_variable = prod_pop_1
		}
	}

	every_province = {
		limit = {
			is_valid_prov = yes
		}
		pop_update_demand = yes
	}

	trade_do_trade = yes
	trade_resolve_trade = yes
	trade_update_merchant = yes
	trade_update_price = yes

	every_province = {
		limit = {
			is_valid_prov = yes
		}
		pop_resolve_demand = yes
		
		change_variable = { name = pop_wealth add = var:pop_earn_free } 
		change_variable = { name = pop_wealth add = var:pop_earn_serf }
		change_variable = { name = pop_wealth subtract = var:pop_pay_free }
		change_variable = { name = pop_wealth subtract = var:pop_pay_serf }
		
		if = {
			limit = {
				has_variable = trade_merchant
			}
			change_variable = { name = pop_wealth add = var:trade_merchant.var:trade_earn }
			change_variable = { name = pop_wealth subtract = var:trade_merchant.var:trade_pay }
		}
	}

	debug_log = "Logging Start"

	set_variable = { name = t_disp value = 0 }

	every_province = {
		limit = {
			is_valid_prov = yes
		}
		prev = {
			set_variable = { name = t_disp_t value = prev.var:pop_wealth }
			change_variable = { name = t_disp_t divide = 100 }
			change_variable = { name = t_disp add = var:t_disp_t }
		}
	}

	debug_log = "Total Wealth: [THIS.Var('t_disp').GetValue]"

	set_variable = { name = t_disp_s value = 0 }

	every_province = {
		limit = {
			is_valid_prov = yes
		}
		prev = {
			set_variable = { name = t_disp_t value = prev.var:pop_total }
			change_variable = { name = t_disp_t divide = 100 }
			change_variable = { name = t_disp_s add = var:t_disp_t }
		}
	}

	set_variable = { name = t_disp value = 0 }

	every_province = {
		limit = {
			is_valid_prov = yes
		}
		prev = {
			set_variable = { name = t_disp_t value = prev.var:pop_calorie }
			change_variable = { name = t_disp_t multiply = prev.var:pop_total }
			change_variable = { name = t_disp_t divide = 100 }
			change_variable = { name = t_disp add = var:t_disp_t }
		}
	}

	change_variable = { name = t_disp divide = var:t_disp_s }

	debug_log = "Average Calorie: [THIS.Var('t_disp').GetValue]"

	set_variable = { name = t_disp value = 0 }

	every_province = {
		limit = {
			is_valid_prov = yes
		}
		prev = {
			set_variable = { name = t_disp_t value = prev.var:pop_nutrient }
			change_variable = { name = t_disp_t multiply = prev.var:pop_total }
			change_variable = { name = t_disp_t divide = 100 }
			change_variable = { name = t_disp add = var:t_disp_t }
		}
	}

	change_variable = { name = t_disp divide = var:t_disp_s }

	debug_log = "Average Nutrient: [THIS.Var('t_disp').GetValue]"

	set_variable = { name = t_disp value = 0 }

	every_province = {
		limit = {
			is_valid_prov = yes
		}
		prev = {
			set_variable = { name = t_disp_t value = prev.var:pop_comfort }
			change_variable = { name = t_disp_t multiply = prev.var:pop_total }
			change_variable = { name = t_disp_t divide = 100 }
			change_variable = { name = t_disp add = var:t_disp_t }
		}
	}

	change_variable = { name = t_disp divide = var:t_disp_s }

	debug_log = "Average Comfort: [THIS.Var('t_disp').GetValue]"

	set_variable = { name = t_disp value = 0 }

	every_province = {
		limit = {
			is_valid_prov = yes
		}
		prev = {
			set_variable = { name = t_disp_t value = prev.var:pop_luxury }
			change_variable = { name = t_disp_t multiply = prev.var:pop_total }
			change_variable = { name = t_disp_t divide = 100 }
			change_variable = { name = t_disp add = var:t_disp_t }
		}
	}

	change_variable = { name = t_disp divide = var:t_disp_s }

	debug_log = "Average Luxury: [THIS.Var('t_disp').GetValue]"

	^^goods^
		set_variable = { name = t_disp value = 0 }

		every_province = {
			limit = {
				is_valid_prov = yes
			}
			prev = {
				set_variable = { name = t_disp_t value = prev.county.var:trade_price_&goods& }
				change_variable = { name = t_disp_t multiply = prev.var:pop_total }
				change_variable = { name = t_disp_t divide = 100 }
				change_variable = { name = t_disp add = var:t_disp_t }
			}
		}
		
		change_variable = { name = t_disp divide = var:t_disp_s }
		
		debug_log = "Average &goods& Price: [THIS.Var('t_disp').GetValue]"
		
		set_variable = { name = t_disp value = 0 }

		every_province = {
			limit = {
				is_valid_prov = yes
				
				has_variable = prod_has_&goods&
			}
			prev = {
				set_variable = { name = t_disp_t value = prev.var:prod_has_&goods& }
				change_variable = { name = t_disp_t divide = 100 }
				change_variable = { name = t_disp add = var:t_disp_t }
			}
		}
		every_in_global_list = {
			limit = {
				has_variable = trade_has_&goods&
			}
			variable = trade_merchants
			prev = {
				set_variable = { name = t_disp_t value = prev.var:trade_has_&goods& }
				change_variable = { name = t_disp_t divide = 100 }
				change_variable = { name = t_disp add = var:t_disp_t }
			}
		}
		
		debug_log = "Total &goods& Stockpile: [THIS.Var('t_disp').GetValue]"
		
		set_variable = { name = t_disp value = 0 }

		every_county = {
			limit = {
				is_valid_prov = yes
				
				has_variable = trade_sum_sply_&goods&
			}
			prev = {
				set_variable = { name = t_disp_t value = prev.var:trade_sum_sply_&goods& }
				change_variable = { name = t_disp_t divide = 400 }
				change_variable = { name = t_disp add = var:t_disp_t }
			}
		}
		
		debug_log = "Total &goods& Supply: [THIS.Var('t_disp').GetValue]"
		
		set_variable = { name = t_disp value = 0 }

		every_county = {
			limit = {
				is_valid_prov = yes
				
				has_variable = trade_dmnd_&goods&
			}
			prev = {
				set_variable = { name = t_disp_t value = prev.var:trade_dmnd_&goods& }
				change_variable = { name = t_disp_t divide = 100 }
				change_variable = { name = t_disp add = var:t_disp_t }
			}
		}
		
		debug_log = "Total &goods& Demand: [THIS.Var('t_disp').GetValue]"
		
		set_variable = { name = t_disp value = 0 }

		every_province = {
			limit = {
				is_valid_prov = yes
				
				has_variable = prod_earn_&goods&
			}
			prev = {
				set_variable = { name = t_disp_t value = prev.var:prod_earn_&goods& }
				change_variable = { name = t_disp_t divide = 100 }
				change_variable = { name = t_disp add = var:t_disp_t }
			}
		}
		
		debug_log = "Total &goods& Revenue: [THIS.Var('t_disp').GetValue]"
	^

	debug_log = "Logging End"
}