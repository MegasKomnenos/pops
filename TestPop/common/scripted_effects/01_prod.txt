prod_new_template = {
	create_character = {
		save_temporary_scope_as = prod_new_template_temp
		gender = male
		trait = character_not_1
		employer = global_var:arhat
		faith = global_var:arhat.faith
		culture = global_var:arhat.culture
	}

	set_global_variable = { name = $name$ value = scope:prod_new_template_temp }
	add_to_global_variable_list = { name = prod_templates target = scope:prod_new_template_temp }
	
	scope:prod_new_template_temp = {
		add_character_flag = { flag = prod_land_$land_type$ }
		
		set_variable = { name = prod_labor value = $labor$ }
		set_variable = { name = prod_land value = $land$ }
		
		^^goods^
			[[dmnd_&goods&] set_variable = { name = prod_dmnd_&goods& value = $dmnd_&goods&$ } ]
			[[sply_&goods&] set_variable = { name = prod_sply_&goods& value = $sply_&goods&$ } ]
		^
	}
}

prod_new_instance = {
	if = {
		limit = {
			has_global_variable = $template$
		}
		create_character = {
			save_temporary_scope_as = prod_new_instance_temp
			gender = male
			trait = character_not_1
			employer = global_var:arhat
			faith = global_var:arhat.faith
			culture = global_var:arhat.culture
		}
		
		add_to_global_variable_list = { name = prod_instances target = scope:prod_new_instance_temp }
		
		global_var:$template$ = {
			add_to_variable_list = { name = prod_instances target = scope:prod_new_instance_temp }
		}
		$location$ = {
			add_to_variable_list = { name = prod_instances target = scope:prod_new_instance_temp }
		}
		
		scope:prod_new_instance_temp = {
			set_variable = { name = prod_template value = global_var:$template$ }
			set_variable = { name = prod_location value = $location$ }
			
			set_variable = { name = prod_size value = 0 }
			set_variable = { name = prod_labor value = 0 }
			set_variable = { name = prod_land value = 0 }
			set_variable = { name = prod_profit value = 0 }
			set_variable = { name = prod_pay value = 0 }
			set_variable = { name = prod_pay_old value = 0 }
			
			^^goods^prod_new_instance_helper = { template = $template$ good = &goods& }^
		}
	}
}

prod_new_instance_helper = {
	if = { 
		limit = { 
			global_var:$template$ = { 
				has_variable = prod_dmnd_$good$ 
			} 
		} 
		set_variable = { name = prod_dmnd_$good$ value = 0 } 
		set_variable = { name = prod_dmnd_old_$good$ value = 0 } 
		set_variable = { name = prod_in_$good$ value = 0 } 
		set_variable = { name = prod_in_old_$good$ value = 0 } 
		set_variable = { name = prod_pay_$good$ value = 0 } 
		set_variable = { name = prod_pay_$good$ value = 0 } 
	}
	if = { 
		limit = { 
			global_var:$template$ = { 
				has_variable = prod_sply_$good$ 
			} 
		} 
		set_variable = { name = prod_sply_$good$ value = 0 }
		set_variable = { name = prod_sply_old_$good$ value = 0 }
	}
}

prod_pop_instance = {
	remove_list_global_variable = { name = prod_instances target = this }
	
	var:prod_template = {
		remove_list_variable = { name = prod_instances target = prev }
	}
	var:prod_location = {
		remove_list_variable = { name = prod_instances target = prev }
	}
	
	death = natural
}

prod_update_instances = {
	every_in_global_list = {
		variable = prod_instances
		
		set_variable = { name = prod_update_instances_t value = 1 }
		set_variable = { name = prod_update_instances_tt value = 0 }
		
		^^goods^prod_update_instances_helper_4 = { good = &goods& }^
		
		if = {
			limit = {
				has_variable = prod_update_instances_tt
				
				var:prod_update_instances_tt > 0
			}
			root_effect = {
				inp = var:prod_update_instances_t
				root = var:prod_update_instances_tt
				return = prod_update_instances_t
			}
		}
		
		^^goods^prod_update_instances_helper_5 = { good = &goods& }^
	}
	
	every_county = {
		limit = {
			is_valid_prov = yes
		}
		^^goods^prod_update_instances_helper_0 = { good = &goods& }^
	}
	
	every_in_global_list = {
		variable = prod_instances
		
		set_variable = { name = prod_labor value = 0 }
		set_variable = { name = prod_land value = 0 }
		
		set_variable = { name = prod_update_instances_t value = 0 }
		
		^^goods^prod_update_instances_helper_1 = { type = dmnd opr = subtract good = &goods& }^
		^^goods^prod_update_instances_helper_1 = { type = sply opr = add good = &goods& }^
		
		if = {
			limit = {
				has_variable = prod_update_instances_t
				
				var:prod_update_instances_t < 0
			}
			set_variable = { name = prod_update_instances_t value = 0 }
		}
		
		change_variable = { name = prod_profit multiply = 0.9 }
		change_variable = { name = prod_profit add = var:prod_update_instances_t }
	}
	
	every_county = {
		limit = {
			is_valid_prov = yes
		}
		prod_update_instances_helper_2 = { land = farm }
		prod_update_instances_helper_2 = { land = pasture }
		prod_update_instances_helper_2 = { land = forest }
		prod_update_instances_helper_2 = { land = workshop }
		
		prod_update_instances_helper_3 = yes
		
		remove_variable = prod_update_instances_t
		
		^^goods^remove_variable = prod_update_instances_&goods&^
	}
	
	every_province = {
		limit = {
			is_valid_prov = yes
		}
		prod_update_instances_helper_2 = { land = farm }
		prod_update_instances_helper_2 = { land = pasture }
		prod_update_instances_helper_2 = { land = forest }
		prod_update_instances_helper_2 = { land = workshop }
		
		prod_update_instances_helper_3 = yes
		
		remove_variable = prod_update_instances_t
	}
	
	every_in_global_list = {
		variable = prod_instances
		
		pow_effect = {
			inp = var:prod_labor
			exp = var:prod_template.var:prod_labor
			return = prod_size
		}
		
		change_variable = { name = prod_size multiply = var:prod_update_instances_t }
		
		^^goods^prod_update_instances_helper_6 = { name = prod_dmnd_&goods& }^
		^^goods^prod_update_instances_helper_6 = { name = prod_sply_&goods& }^
		
		remove_variable = prod_update_instances_t
		remove_variable = prod_update_instances_tt
	}
}

prod_update_instances_helper_0 = {
	if = {
		limit = {
			has_variable = trade_sum_sply_$good$ 
			has_variable = trade_has_$good$
			
			var:trade_sum_sply_$good$ > 0
			var:trade_has_$good$ > 0
		}
		set_variable = { name = prod_update_instances_$good$ value = var:trade_sum_sply_$good$ }
		change_variable = { name = prod_update_instances_$good$ divide = 2 }
		change_variable = { name = prod_update_instances_$good$ divide = var:trade_has_$good$ }
		
		if = {
			limit = {
				var:prod_update_instances_$good$ > 1
			}
			set_variable = { name = prod_update_instances_$good$ value = 1 }
		}
		else = {
			change_variable = { name = prod_update_instances_$good$ add = 0.25 }
			change_variable = { name = prod_update_instances_$good$ divide = 1.25 }
		}
	}
	else = {
		set_variable = { name = prod_update_instances_$good$ value = 1 }
	}
	
	change_variable = { name = prod_update_instances_$good$ multiply = var:trade_price_$good$ }
}

prod_update_instances_helper_1 = {
	if = {
		limit = {
			var:prod_template = {
				has_variable = prod_$type$_$good$
				
				var:prod_$type$_$good$ > 0
			}
		}
		set_variable = { name = prod_update_instances_tt value = var:prod_template.var:prod_$type$_$good$ }
		change_variable = { name = prod_update_instances_tt multiply = var:prod_location.county.var:prod_update_instances_$good$ }
		change_variable = { name = prod_update_instances_tt multiply = var:prod_location.var:modi_prod_$type$_$good$ }
		change_variable = { name = prod_update_instances_t $opr$ = var:prod_update_instances_tt }
	}
}

prod_update_instances_helper_2 = {
	if = {
		limit = {
			has_variable = $land$_total
			
			var:$land$_total > 0
		}
		set_variable = { name = prod_update_instances_t value = 0 }
		
		every_in_list = {
			limit = {
				var:prod_template = {
					has_character_flag = prod_land_$land$
				}
			}
			variable = prod_instances
			
			set_variable = { name = prod_land value = var:prod_profit }
			change_variable = { name = prod_land multiply = var:prod_template.var:prod_land }
			change_variable = { name = prod_land multiply = var:prod_land }
			
			prev = {
				change_variable = { name = prod_update_instances_t add = prev.var:prod_land }
			}
		}
		
		if = {
			limit = {
				has_variable = prod_update_instances_t
				
				var:prod_update_instances_t > 0
			}
			every_in_list = {
				limit = {
					var:prod_template = {
						has_character_flag = prod_land_$land$
					}
				}
				variable = prod_instances
				
				change_variable = { name = prod_land multiply = 100 }
				change_variable = { name = prod_land divide = prev.var:prod_update_instances_t }
				change_variable = { name = prod_land multiply = prev.var:$land$_total }
				change_variable = { name = prod_land divide = 100 }
			}
		}
		else = {
			every_in_list = {
				limit = {
					var:prod_template = {
						has_character_flag = prod_land_$land$
					}
				}
				variable = prod_instances
				
				set_variable = { name = prod_land value = 0 }
			}
		}
	}
}

prod_update_instances_helper_3 = {
	set_variable = { name = prod_update_instances_t value = 0 }
		
	every_in_list = {
		variable = prod_instances
		
		pow_effect = {
			inp = var:prod_land
			exp = var:prod_template.var:prod_land
			return = prod_update_instances_t
		}
		
		set_variable = { name = prod_labor value = var:prod_profit }
		change_variable = { name = prod_labor multiply = var:prod_template.var:prod_labor }
		change_variable = { name = prod_labor multiply = var:prod_labor }
		change_variable = { name = prod_labor multiply = var:prod_update_instances_t }
		
		prev = {
			change_variable = { name = prod_update_instances_t add = prev.var:prod_labor }
		}
	}
	
	if = {
		limit = {
			has_variable = prod_update_instances_t
			
			var:prod_update_instances_t > 0
		}
		every_in_list = {
			variable = prod_instances
			
			change_variable = { name = prod_labor multiply = 100 }
			change_variable = { name = prod_labor divide = prev.var:prod_update_instances_t }
			change_variable = { name = prod_labor multiply = prev.var:pop_total }
			change_variable = { name = prod_labor divide = 100 }
		}
	}
	else = {
		every_in_list = {
			variable = prod_instances
			
			set_variable = { name = prod_labor value = 0 }
		}
	}
}

prod_update_instances_helper_4 = {
	if = {
		limit = {
			has_variable = prod_dmnd_$good$
		}
		if = {
			limit = {
				var:prod_dmnd_$good$ = {
					compare_value != prev.var:prod_in_$good$
				}
			}
			change_variable = { name = prod_update_instances_t multiply = var:prod_in_$good$ }
			change_variable = { name = prod_update_instances_t divide = var:prod_dmnd_$good$ }
		}
		
		change_variable = { name = prod_update_instances_tt add = 1 }
		
		set_variable = { name = prod_dmnd_old_$good$ value = var:prod_dmnd_$good$ }
		set_variable = { name = prod_in_old_$good$ value = var:prod_in_$good$ }
	}
}

prod_update_instances_helper_5 = {
	if = {
		limit = {
			has_variable = prod_sply_$good$
		}
		set_variable = { name = prod_sply_old_$good$ value = var:prod_sply_$good$ }
		change_variable = { name = prod_sply_old_$good$ multiply = var:prod_update_instances_t }
	}
}

prod_update_instances_helper_6 = {
	if = {
		limit = {
			has_variable = $name$
		}
		set_variable = { name = $name$ value = var:prod_template.var:$name$ }
		change_variable = { name = $name$ multiply = var:prod_size }
		change_variable = { name = $name$ multiply = var:prod_location.var:modi_$name$ }
	}
}