trade_new_merchant = {
	create_character = {
		save_temporary_scope_as = trade_new_merchant_t
		gender = male
		trait = character_not_1
		employer = global_var:arhat
		faith = global_var:arhat.faith
		culture = global_var:arhat.culture
	}
	
	add_to_global_variable_list = { name = trade_merchants target = scope:trade_new_merchant_t }
	
	$location$ = {
		set_variable = { name = trade_merchant value = scope:trade_new_merchant_t }
	}
	
	scope:trade_new_merchant_t = {
		set_variable = { name = trade_location value = $location$ }
		set_variable = { name = trade_tax value = $tax$ }
		set_variable = { name = trade_wealth value = $wealth$ }
		
		set_variable = { name = trade_profit value = 0 }
		set_variable = { name = trade_earn value = 0 }
		set_variable = { name = trade_pay value = 0 }
		
		^^goods^
			set_variable = { name = trade_has_&goods& value = 0 }
			set_variable = { name = trade_want_&goods& value = 0 }
			set_variable = { name = trade_price_&goods& value = $location$.county.var:trade_price_&goods& }
		^
		
		set_variable = { name = trade_rank value = $rank$ }
		set_variable = { name = trade_skill value = $skill$ }
		set_variable = { name = trade_outposts_max value = $outpost$ }
		
		add_to_variable_list = { name = trade_outposts target = $location$ }
	}
}

trade_pop_merchant = {
	remove_list_global_variable = { name = trade_merchants target = this }
	
	var:trade_location = {
		remove_variable = trade_merchant
		
		^^goods^
			remove_variable = trade_price_&goods&
			remove_variable = trade_has_&goods&
			remove_variable = trade_earn_&goods&
			remove_variable = trade_pay_&goods&
		^
		
		remove_variable = trade_rank
		remove_variable = trade_skill
		remove_variable = trade_outposts_max
		remove_variable = trade_wealth
		remove_variable = trade_earn
		remove_variable = trade_pay
	}
	
	death = natural
}

trade_copy_merchant_data_to_holding = {
	^^goods^
		set_variable = { name = trade_price_&goods& value = var:trade_merchant.var:trade_price_&goods& }
		set_variable = { name = trade_has_&goods& value = var:trade_merchant.var:trade_has_&goods& }
		set_variable = { name = trade_earn_&goods& value = var:trade_merchant.var:trade_earn_&goods& }
		set_variable = { name = trade_pay_&goods& value = var:trade_merchant.var:trade_pay_&goods& }
	^
	
	set_variable = { name = trade_rank value = var:trade_merchant.var:trade_rank }
	set_variable = { name = trade_skill value = var:trade_merchant.var:trade_skill }
	set_variable = { name = trade_outposts_max value = var:trade_merchant.var:trade_outposts_max }
	set_variable = { name = trade_wealth value = var:trade_merchant.var:trade_wealth }
	set_variable = { name = trade_earn value = var:trade_merchant.var:trade_earn }
	set_variable = { name = trade_pay value = var:trade_merchant.var:trade_pay }
}

trade_do_trade = {
	every_county = {
		limit = {
			is_valid_prov = yes
		}
		^^goods^
			set_variable = { name = trade_sply_&goods& value = 0 }
			set_variable = { name = trade_dmnd_&goods& value = 0 }
		^
		
		trade_do_trade_helper_0 = yes
		
		^^goods^trade_do_trade_helper_1 = { good = &goods& }^
	}
	
	every_in_global_list = {
		variable = trade_merchants
		
		^^goods^
			set_variable = { name = trade_in_&goods& value = 0 }
			set_variable = { name = trade_out_&goods& value = 0 }
			
			set_variable = { name = trade_dmnd_&goods& value = var:trade_want_&goods& }
			change_variable = { name = trade_dmnd_&goods& subtract = var:trade_has_&goods& }
			change_variable = { name = trade_dmnd_&goods& divide = 2 }
			
			set_variable = { name = trade_sply_&goods& value = var:trade_has_&goods& }
			change_variable = { name = trade_sply_&goods& divide = 2 }
			
			set_variable = { name = trade_earn_&goods& value = 0 }
			set_variable = { name = trade_pay_&goods& value = 0 }
		^
		
		set_variable = { name = trade_power value = var:trade_rank }
		change_variable = { name = trade_power multiply = var:trade_skill }
		change_variable = { name = trade_power divide = 100 }
	}
	
	every_province = {
		limit = {
			is_valid_prov = yes
		}
		set_variable = { name = trade_route value = 0 }
	}
	
	set_global_variable = { name = trade_do_trade_loop }
	
	while = {
		limit = {
			has_global_variable = trade_do_trade_loop
		}
		count = 100000
		
		remove_global_variable = trade_do_trade_loop
		
		ordered_in_global_list = {
			limit = {
				has_variable = trade_power
				
				var:trade_power > 0
			}
			variable = trade_merchants
			order_by = trade_do_trade_order_value_0
			position = 0
			
			set_global_variable = { name = trade_do_trade_loop }
			
			set_global_variable = { name = trade_do_trade_select value = this }
			
			travel_distance_dijkstra_every = {
				start = var:trade_location
				start_list = trade_outposts
				max = 285
				return_dist = trade_do_trade_dist
				return_prev = trade_do_trade_prev
			}
			
			every_county = {
				limit = {
					any_county_province = {
						has_variable = trade_do_trade_dist
					}
				}
				add_to_global_variable_list = { name = trade_do_trade_list target = this }
				
				ordered_county_province = {
					limit = {
						has_variable = trade_do_trade_dist
					}
					order_by = trade_do_trade_order_value_1
					position = 0
					
					prev = {
						set_variable = { name = trade_do_trade_dist value = prev.var:trade_do_trade_dist }
						set_variable = { name = trade_do_trade_prev value = prev }
					}
				}
			}
			
			set_variable = { name = trade_do_trade_select }
			
			every_in_global_list = {
				limit = {
					NOT = {
						has_variable = trade_do_trade_select
					}
					
					var:trade_location.county = {
						has_variable = trade_do_trade_dist
					}
				}
				variable = trade_merchants
				
				add_to_global_variable_list = { name = trade_do_trade_list target = this }
				
				set_variable = { name = trade_do_trade_dist value = var:trade_location.county.var:trade_do_trade_dist }
				set_variable = { name = trade_do_trade_prev value = var:trade_location.county.var:trade_do_trade_prev }
			}
			
			remove_variable = trade_do_trade_select
			
			^^goods^
				set_variable = { name = trade_sum_buy_&goods& value = 0 }
				set_variable = { name = trade_sum_sell_&goods& value = 0 }
				
				set_variable = { name = trade_buy_&goods& value = var:trade_dmnd_&goods& }
				change_variable = { name = trade_buy_&goods& subtract = var:trade_in_&goods& }
				
				set_variable = { name = trade_sell_&goods& value = var:trade_sply_&goods& }
				change_variable = { name = trade_sell_&goods& subtract = var:trade_out_&goods& }
			^
			
			every_in_global_list = {
				variable = trade_do_trade_list
				
				set_variable = { name = trade_cost value = var:trade_do_trade_dist }
				change_variable = { name = trade_cost divide = 15 }
				change_variable = { name = trade_cost add = 1 }
				
				^^goods^
					set_variable = { name = trade_point_&goods& value = var:trade_price_&goods& }
					change_variable = { name = trade_point_&goods& subtract = prev.var:trade_price_&goods& }
					change_variable = { name = trade_point_&goods& divide = var:trade_cost }
					change_variable = { name = trade_point_&goods& multiply = var:trade_point_&goods& }
					change_variable = { name = trade_point_&goods& add = 0.01 }
				^
				
				set_variable = { name = trade_point_min value = 210000 }
				
				^^goods^
					if = { 
						limit = { 
							OR = { 
								NOT = { 
									has_variable = trade_point_min 
								} 
								
								var:trade_point_min = { 
									compare_value > prev.var:trade_point_&goods& 
								} 
							} 
						} 
						set_variable = { name = trade_point_min value = var:trade_point_&goods& } 
					}
				^
				
				^^goods^
					set_variable = { name = trade_buy_&goods& value = var:trade_dmnd_&goods& }
					change_variable = { name = trade_buy_&goods& subtract = var:trade_in_&goods& }
					set_variable = { name = trade_sell_&goods& value = var:trade_sply_&goods& }
					change_variable = { name = trade_sell_&goods& subtract = var:trade_out_&goods& }
					
					if = { 
						limit = { 
							var:trade_price_&goods& = { 
								compare_value >= global_var:trade_do_trade_select.var:trade_price_&goods& 
							} 
						} 
						set_variable = { name = trade_sell_&goods& value = 0 } 
					}
					if = { 
						limit = { 
							var:trade_price_&goods& = { 
								compare_value <= global_var:trade_do_trade_select.var:trade_price_&goods& 
							} 
						} 
						set_variable = { name = trade_buy_&goods& value = 0 } 
					}
				^
				
				prev = {
					^^goods^
						change_variable = { name = trade_sum_buy_&goods& add = prev.var:trade_buy_&goods& }
						change_variable = { name = trade_sum_sell_&goods& add = prev.var:trade_sell_&goods& }
					^
				}
				
				change_variable = { name = trade_cost divide = 100 }
			}
			
			set_variable = { name = trade_cost value = 0 }
			
			^^goods^trade_do_trade_helper_2 = { good = &goods& type0 = buy type1 = sell }^
			^^goods^trade_do_trade_helper_2 = { good = &goods& type0 = sell type1 = buy }^
			
			set_variable = { name = trade_cost value = 0 }
			
			every_in_global_list = {
				variable = trade_do_trade_list
				
				^^goods^
					set_variable = { name = trade_cost_&goods& value = var:trade_buy_&goods& }
					change_variable = { name = trade_cost_&goods& add = var:trade_sell_&goods& }
					change_variable = { name = trade_cost_&goods& multiply = var:trade_cost }
				^
				
				prev = {
					^^goods^
						change_variable = { name = trade_cost add = prev.var:trade_cost_&goods& }
					^
				}
			}
			
			if = {
				limit = {
					has_variable = trade_cost
					
					var:trade_cost = {
						compare_value > prev.var:trade_power
					}
				}
				set_variable = { name = trade_point_min value = 0.01 }
				
				ordered_in_global_list = {
					limit = {
						trade_has_trade = yes
					}
					variable = trade_do_trade_list
					order_by = trade_do_trade_order_value_2
					position = 0
					
					prev = {
						set_variable = { name = trade_point_min value = prev.var:trade_point_min }
					}
				}
				
				set_variable = { name = trade_do_trade_t value = var:trade_power }
				change_variable = { name = trade_do_trade_t multiply = 100 }
				change_variable = { name = trade_do_trade_t divide = var:trade_cost }
				
				set_variable = { name = trade_cost value = 0 }
				
				every_in_global_list = {
					limit = {
						trade_has_trade = yes
					}
					variable = trade_do_trade_list
					
					^^goods^trade_do_trade_helper_3 = { good = &goods& }^
					
					prev = {
						^^goods^change_variable = { name = trade_cost add = prev.var:trade_cost_&goods& }^
					}
				}
				
				if = {
					limit = {
						has_variable = trade_cost
						
						var:trade_cost = {
							compare_value > prev.var:trade_power
						}
					}
					set_variable = { name = trade_do_trade_t value = var:trade_power }
					change_variable = { name = trade_do_trade_t multiply = 100 }
					change_variable = { name = trade_do_trade_t divide = var:trade_cost }
					
					every_in_global_list = {
						limit = {
							trade_has_trade = yes
						}
						variable = trade_do_trade_list
						
						^^goods^
							change_variable = { name = trade_buy_&goods& multiply = prev.var:trade_do_trade_t }
							change_variable = { name = trade_sell_&goods& multiply = prev.var:trade_do_trade_t }
							change_variable = { name = trade_buy_&goods& divide = 100 }
							change_variable = { name = trade_sell_&goods& divide = 100 }
						^
					}
				}
				
				^^goods^
					set_variable = { name = trade_sum_buy_&goods& value = 0 }
					set_variable = { name = trade_sum_sell_&goods& value = 0 }
				^
				
				every_in_global_list = {
					limit = {
						trade_has_trade = yes
					}
					variable = trade_do_trade_list
					
					prev = {
						^^goods^
							change_variable = { name = trade_sum_buy_&goods& add = prev.var:trade_buy_&goods& }
							change_variable = { name = trade_sum_sell_&goods& add = prev.var:trade_sell_&goods& }
						^
					}
				}
				
				every_in_global_list = {
					limit = {
						trade_has_trade = yes
					}
					variable = trade_do_trade_list
					
					remove_variable = trade_do_trade_t
				}
				
				remove_variable = trade_do_trade_t
				remove_variable = trade_point_min
			}
			
			^^goods^
				change_variable = { name = trade_in_&goods& add = var:trade_sum_sell_&goods& }
				change_variable = { name = trade_out_&goods& add = var:trade_sum_buy_&goods& }
			^
			
			every_in_global_list = {
				variable = trade_do_trade_list
				
				set_variable = { name = trade_route_t value = 0 }
				
				^^goods^trade_do_trade_helper_4 = { good = &goods& }^
				
				change_variable = { name = trade_route_t divide = 100 }
				
				if = {
					limit = {
						has_variable = trade_route_t
						
						var:trade_route_t > 0
					}
					var:trade_do_trade_prev = {
						save_temporary_scope_as = trade_route_t
					}
					
					while = {
						limit = {
							NOT = {
								scope:trade_route_t.var:trade_do_trade_prev = scope:trade_route_t
							}
						}
						scope:trade_route_t = {
							if = {
								limit = {
									var:prov_sea = 1
								}
								change_variable = { name = trade_route add = prev.var:trade_route_t }
							}
							
							var:trade_do_trade_prev = {
								save_temporary_scope_as = trade_route_t
							}
						}
					}
					
					scope:trade_route_t = {
						if = {
							limit = {
								var:prov_sea = 1
							}
							change_variable = { name = trade_route add = prev.var:trade_route_t }
						}
					}
				}
				
				remove_variable = trade_route_t
			}
			
			every_in_global_list = {
				variable = trade_do_trade_list
				
				remove_variable = trade_do_trade_dist
				remove_variable = trade_do_trade_prev
			}
			
			every_province = {
				limit = {
					has_variable = trade_do_trade_dist
				}
				remove_variable = trade_do_trade_dist
				remove_variable = trade_do_trade_prev
			}
			
			remove_global_variable = trade_do_trade_select
			clear_global_variable_list = trade_do_trade_list
			
			set_variable = { name = trade_power value = 0 }
		}
	}
	
	every_county = {
		limit = {
			is_valid_prov = yes
		}
		
	}
	
	every_in_global_list = {
		variable = trade_merchants
		
		^^goods^
			remove_variable = trade_buy_&goods&
			remove_variable = trade_sell_&goods&
			remove_variable = trade_point_&goods&
			remove_variable = trade_cost_&goods&
			remove_variable = trade_sum_buy_&goods&
			remove_variable = trade_sum_sell_&goods&
		^
		remove_variable = trade_point_min
		remove_variable = trade_cost
		remove_variable = trade_do_trade_t
	}
	
	set_global_variable = { name = trade_route_max value = 0 }
	
	ordered_province = {
		limit = {
			has_variable = trade_route
			
			var:trade_route > 0
		}
		order_by = trade_do_trade_order_value_3
		position = 0
		
		set_global_variable = { name = trade_route_max value = var:trade_route }
	}
	
	if = {
		limit = {
			has_global_variable = trade_route_max
			
			global_var:trade_route_max > 0
		}
		every_province = {
			limit = {
				has_variable = trade_route
			}
			change_variable = { name = trade_route multiply = 100 }
			change_variable = { name = trade_route divide = global_var:trade_route_max }
		}
	}
}

trade_do_trade_helper_0 = {
	save_temporary_scope_as = trade_do_trade_select
	
	every_county_province = {
		limit = {
			is_valid_prov = yes
		}
		every_in_list = {
			variable = prod_instances
			
			^^goods^
				if = { 
					limit = { 
						has_variable = prod_dmnd_&goods& 
					} 
					scope:trade_do_trade_select = { 
						change_variable = { name = trade_dmnd_&goods& add = prev.var:prod_dmnd_&goods& } 
					} 
				}
				if = { 
					limit = { 
						has_variable = prod_sply_old_&goods& 
					} 
					scope:trade_do_trade_select = { 
						change_variable = { name = trade_sply_&goods& add = prev.var:prod_sply_old_&goods& } 
					} 
				}
			^
		}
		
		scope:trade_do_trade_select = {
			^^goods^
				change_variable = { name = trade_dmnd_&goods& add = prev.var:pop_calorie_&goods& }
				change_variable = { name = trade_dmnd_&goods& add = prev.var:pop_nutrient_&goods& }
				change_variable = { name = trade_dmnd_&goods& add = prev.var:pop_comfort_&goods& }
				change_variable = { name = trade_dmnd_&goods& add = prev.var:pop_luxury_&goods& }
			^
		}
	}
}

trade_do_trade_helper_1 = {
	if = {
		limit = {
			has_variable = trade_sply_$good$
			
			var:trade_sply_$good$ > 0
		}
		change_variable = { name = trade_has_$good$ add = var:trade_sply_$good$ }
	}
	
	change_variable = { name = trade_sum_sply_$good$ multiply = 0.75 }
	change_variable = { name = trade_sum_sply_$good$ add = var:trade_sply_$good$ }
	
	if = {
		limit = {
			has_variable = trade_has_$good$
			
			var:trade_has_$good$ > 0
		}
		set_variable = { name = trade_sply_$good$ value = var:trade_has_$good$ }
		change_variable = { name = trade_sply_$good$ divide = 2 }
	}
	else = {
		set_variable = { name = trade_sply_$good$ value = 0 }
	}
	
	if = {
		limit = {
			has_variable = trade_sply_$good$
			has_variable = trade_dmnd_$good$
			
			var:trade_sply_$good$ > 0
			var:trade_dmnd_$good$ > 0
		}
		if = {
			limit = {
				var:trade_sply_$good$ = {
					compare_value >= prev.var:trade_dmnd_$good$
				}
			}
			set_variable = { name = trade_in_$good$ value = var:trade_dmnd_$good$ }
			set_variable = { name = trade_out_$good$ value = var:trade_dmnd_$good$ }
		}
		else = {
			set_variable = { name = trade_in_$good$ value = var:trade_sply_$good$ }
			set_variable = { name = trade_out_$good$ value = var:trade_sply_$good$ }
		}
		
		set_variable = { name = trade_earn_$good$ value = var:trade_out_$good$ }
		set_variable = { name = trade_pay_$good$ value = var:trade_in_$good$ }
		
		change_variable = { name = trade_earn_$good$ multiply = var:trade_price_$good$ }
		change_variable = { name = trade_pay_$good$ multiply = var:trade_price_$good$ }
	}
	else = {
		set_variable = { name = trade_in_$good$ value = 0 }
		set_variable = { name = trade_out_$good$ value = 0 }
		set_variable = { name = trade_earn_$good$ value = 0 }
		set_variable = { name = trade_pay_$good$ value = 0 }
	}
}

trade_do_trade_helper_2 = {
	if = {
		limit = {
			OR = {
				AND = {
					var:trade_$type1$_$good$ = 0
					
					NOT = {
						var:trade_sum_$type0$_$good$ = 0
					}
				}
				
				var:trade_$type1$_$good$ = {
					compare_value < prev.var:trade_sum_$type0$_$good$
				}
			}
		}
		set_variable = { name = trade_point_min value = 0.01 }
		
		ordered_in_global_list = {
			limit = {
				var:trade_$type0$_$good$ > 0
			}
			variable = trade_do_trade_list
			order_by = trade_do_trade_order_value_$good$
			position = 0
			
			prev = {
				set_variable = { name = trade_point_min value = prev.var:trade_point_$good$ }
			}
		}
		
		set_variable = { name = trade_do_trade_helper_2_t value = var:trade_$type1$_$good$ }
		change_variable = { name = trade_do_trade_helper_2_t multiply = 100 }
		change_variable = { name = trade_do_trade_helper_2_t divide = var:trade_sum_$type0$_$good$ }
		
		set_variable = { name = trade_sum_$type0$_$good$ value = 0 }
		
		every_in_global_list = {
			limit = {
				var:trade_$type0$_$good$ > 0
			}
			variable = trade_do_trade_list
			
			set_variable = { name = trade_do_trade_helper_2_t value = 100 }
			change_variable = { name = trade_do_trade_helper_2_t subtract = prev.var:trade_do_trade_helper_2_t }
			change_variable = { name = trade_do_trade_helper_2_t multiply = prev.var:trade_point_min }
			change_variable = { name = trade_do_trade_helper_2_t divide = var:trade_point_$good$ }
			change_variable = { name = trade_do_trade_helper_2_t multiply = -1 }
			change_variable = { name = trade_do_trade_helper_2_t add = 100 }
			
			change_variable = { name = trade_$type0$_$good$ multiply = var:trade_do_trade_helper_2_t }
			change_variable = { name = trade_$type0$_$good$ divide = 100 }
			
			prev = {
				change_variable = { name = trade_sum_$type0$_$good$ add = prev.var:trade_$type0$_$good$ }
			}
		}
		
		if = {
			limit = {
				var:trade_$type1$_$good$ = {
					compare_value < prev.var:trade_sum_$type0$_$good$
				}
			}
			set_variable = { name = trade_do_trade_helper_2_t value = var:trade_$type1$_$good$ }
			change_variable = { name = trade_do_trade_helper_2_t multiply = 100 }
			change_variable = { name = trade_do_trade_helper_2_t divide = var:trade_sum_$type0$_$good$ }
			
			every_in_global_list = {
				limit = {
					var:trade_$type0$_$good$ > 0
				}
				variable = trade_do_trade_list
				
				change_variable = { name = trade_$type0$_$good$ multiply = prev.var:trade_do_trade_helper_2_t }
				change_variable = { name = trade_$type0$_$good$ divide = 100 }
			}
		}
		
		set_variable = { name = trade_sum_$type0$_$good$ value = 0 }
		
		every_in_global_list = {
			limit = {
				var:trade_$type0$_$good$ > 0
			}
			variable = trade_do_trade_list
			
			prev = {
				change_variable = { name = trade_sum_$type0$_$good$ add = prev.var:trade_$type0$_$good$ }
			}
		}
		
		every_in_global_list = {
			limit = {
				var:trade_$type0$_$good$ > 0
			}
			variable = trade_do_trade_list
			remove_variable = trade_do_trade_helper_2_t
		}
		
		remove_variable = trade_do_trade_helper_2_t
	}
}

trade_do_trade_helper_3 = {
	set_variable = { name = trade_do_trade_t value = 100 }
	change_variable = { name = trade_do_trade_t subtract = prev.var:trade_do_trade_t }
	change_variable = { name = trade_do_trade_t multiply = prev.var:trade_point_min }
	change_variable = { name = trade_do_trade_t divide = var:trade_point_$good$ }
	change_variable = { name = trade_do_trade_t multiply = -1 }
	change_variable = { name = trade_do_trade_t add = 100 }
	
	change_variable = { name = trade_buy_$good$ multiply = var:trade_do_trade_t }
	change_variable = { name = trade_sell_$good$ multiply = var:trade_do_trade_t }
	
	change_variable = { name = trade_buy_$good$ divide = 100 }
	change_variable = { name = trade_sell_$good$ divide = 100 }
	
	set_variable = { name = trade_cost_$good$ value = var:trade_buy_$good$ }
	change_variable = { name = trade_cost_$good$ add = var:trade_sell_$good$ }
	change_variable = { name = trade_cost_$good$ multiply = var:trade_cost }
}

trade_do_trade_helper_4 = {
	set_variable = { name = trade_do_trade_t value = var:trade_price_$good$ }
	change_variable = { name = trade_do_trade_t add = prev.var:trade_price_$good$ }
	change_variable = { name = trade_do_trade_t divide = 2 }
	
	if = {
		limit = {
			has_variable = trade_buy_$good$ 
			
			var:trade_buy_$good$ > 0
		}
		change_variable = { name = trade_in_$good$ add = var:trade_buy_$good$ }
		change_variable = { name = trade_route_t add = var:trade_buy_$good$ }
		change_variable = { name = trade_buy_$good$ multiply = var:trade_do_trade_t }
		change_variable = { name = trade_pay_$good$ add = var:trade_buy_$good$ }
		
		prev = {
			change_variable = { name = trade_earn_$good$ add = prev.var:trade_buy_$good$ }
		}
	}
	if = {
		limit = {
			has_variable = trade_sell_$good$
			
			var:trade_sell_$good$ > 0
		}
		change_variable = { name = trade_out_$good$ add = var:trade_sell_$good$ }
		change_variable = { name = trade_route_t add = var:trade_sell_$good$ }
		change_variable = { name = trade_sell_$good$ multiply = var:trade_do_trade_t }
		change_variable = { name = trade_earn_$good$ add = var:trade_sell_$good$ }
		
		prev = {
			change_variable = { name = trade_pay_$good$ add = prev.var:trade_sell_$good$ }
		}
	}
}

trade_resolve_trade = {
	every_province = {
		limit = {
			is_valid_prov = yes
		}
		set_variable = { name = pop_pay_calorie value = 0 }
		set_variable = { name = pop_pay_nutrient value = 0 }
		set_variable = { name = pop_pay_comfort value = 0 }
		set_variable = { name = pop_pay_luxury value = 0 }
		
		^^goods^set_variable = { name = prod_earn_&goods& value = 0 }^
	}
	every_in_global_list = {
		variable = prod_instances
		
		^^goods^set_variable = { name = prod_pay_&goods& value = 0 }^
	}
	
	every_county = {
		limit = {
			is_valid_prov = yes
		}
		^^goods^trade_resolve_trade_helper_0 = { good = &goods& }^
		^^goods^trade_resolve_trade_helper_1 = { good = &goods& }^
		
		remove_variable = trade_resolve_trade_t
		remove_variable = trade_resolve_trade_tt
	}
	
	every_province = {
		limit = {
			is_valid_prov = yes
		}
		set_variable = { name = pop_pay_serf value = 0 }
		set_variable = { name = pop_pay_free value = 0 }
		
		set_variable = { name = trade_resolve_trade_t value = var:pop_pay_calorie }
		change_variable = { name = trade_resolve_trade_t multiply = var:pop_free_calorie }
		change_variable = { name = pop_pay_serf add = var:pop_pay_calorie }
		change_variable = { name = pop_pay_serf subtract = var:trade_resolve_trade_t }
		change_variable = { name = pop_pay_free add = var:trade_resolve_trade_t }
		
		set_variable = { name = trade_resolve_trade_t value = var:pop_pay_nutrient }
		change_variable = { name = trade_resolve_trade_t multiply = var:pop_free_nutrient }
		change_variable = { name = pop_pay_serf add = var:pop_pay_nutrient }
		change_variable = { name = pop_pay_serf subtract = var:trade_resolve_trade_t }
		change_variable = { name = pop_pay_free add = var:trade_resolve_trade_t }
		
		set_variable = { name = trade_resolve_trade_t value = var:pop_pay_comfort }
		change_variable = { name = trade_resolve_trade_t multiply = var:pop_free_comfort }
		change_variable = { name = pop_pay_serf add = var:pop_pay_comfort }
		change_variable = { name = pop_pay_serf subtract = var:trade_resolve_trade_t }
		change_variable = { name = pop_pay_free add = var:trade_resolve_trade_t }
		
		set_variable = { name = trade_resolve_trade_t value = var:pop_pay_luxury }
		change_variable = { name = trade_resolve_trade_t multiply = var:pop_free_luxury }
		change_variable = { name = pop_pay_serf add = var:pop_pay_luxury }
		change_variable = { name = pop_pay_serf subtract = var:trade_resolve_trade_t }
		change_variable = { name = pop_pay_free add = var:trade_resolve_trade_t }
		
		set_variable = { name = trade_resolve_trade_t value = 0 }
		
		^^goods^change_variable = { name = trade_resolve_trade_t add = var:prod_earn_&goods& }^
		
		set_variable = { name = pop_earn_free value = var:pop_freedom }
		change_variable = { name = pop_earn_free multiply = var:trade_resolve_trade_t }
		
		set_variable = { name = pop_earn_serf value = var:trade_resolve_trade_t }
		change_variable = { name = pop_earn_serf subtract = var:pop_earn_free }
		
		remove_variable = trade_resolve_trade_t
		remove_variable = trade_resolve_trade_tt
	}
	
	every_in_global_list = {
		variable = prod_instances
		
		set_variable = { name = prod_pay_old value = var:prod_pay }
		
		set_variable = { name = prod_pay value = 0 } 
		
		^^goods^change_variable = { name = prod_pay add = var:prod_pay_&goods& }^
	}
}

trade_resolve_trade_helper_0 = {
	change_variable = { name = trade_has_$good$ subtract = var:trade_out_$good$ }
	
	set_variable = { name = trade_resolve_trade_t value = 0 }
	
	every_county_province = {
		limit = {
			is_valid_prov = yes
		}
		every_in_list = {
			limit = {
				has_variable = prod_sply_old_$good$
			}
			variable = prod_instances
			
			prev = {
				change_variable = { name = prod_has_$good$ add = prev.var:prod_sply_old_$good$ }
			}
		}
		
		prev = {
			change_variable = { name = trade_resolve_trade_t add = prev.var:prod_has_$good$ }
		}
	}
	
	if = {
		limit = {
			has_variable = trade_resolve_trade_t
			
			var:trade_resolve_trade_t > 0
		}
		every_county_province = {
			limit = {
				is_valid_prov = yes
			}
			change_variable = { name = prod_has_$good$ multiply = 100 }
			change_variable = { name = prod_has_$good$ divide = prev.var:trade_resolve_trade_t }
			change_variable = { name = prod_has_$good$ multiply = prev.var:trade_has_$good$ }
			change_variable = { name = prod_has_$good$ divide = 100 }
		}
	}
	
	if = {
		limit = {
			has_variable = trade_earn_$good$
			
			var:trade_earn_$good$ > 0
		}
		every_county_province = {
			limit = {
				is_valid_prov = yes
			}
			set_variable = { name = prod_earn_$good$ value = var:prod_has_$good$ }
			change_variable = { name = prod_earn_$good$ multiply = 100 }
			change_variable = { name = prod_earn_$good$ divide = prev.var:trade_has_$good$ }
			change_variable = { name = prod_earn_$good$ multiply = prev.var:trade_earn_$good$ }
			change_variable = { name = prod_earn_$good$ divide = 100 }
		}
	}
}

trade_resolve_trade_helper_1 = {
	if = {
		limit = {
			has_variable = trade_dmnd_$good$
			
			var:trade_dmnd_$good$ > 0
		}
		set_variable = { name = trade_resolve_trade_t value = var:trade_pay_$good$ }
		change_variable = { name = trade_resolve_trade_t divide = var:trade_dmnd_$good$ }
		
		set_variable = { name = trade_resolve_trade_tt value = var:trade_in_$good$ }
		change_variable = { name = trade_resolve_trade_tt multiply = 100 }
		change_variable = { name = trade_resolve_trade_tt divide = var:trade_dmnd_$good$ }
		
		every_county_province = {
			limit = {
				is_valid_prov = yes
			}
			set_variable = { name = trade_resolve_trade_t value = prev.var:trade_resolve_trade_t }
			set_variable = { name = trade_resolve_trade_tt value = prev.var:trade_resolve_trade_t }
			
			trade_resolve_trade_helper_1_helper = { type = calorie good = $good$ }
			trade_resolve_trade_helper_1_helper = { type = nutrient good = $good$ }
			trade_resolve_trade_helper_1_helper = { type = comfort good = $good$ }
			trade_resolve_trade_helper_1_helper = { type = luxury good = $good$ }
			
			every_in_list = {
				limit = {
					has_variable = prod_dmnd_$good$
				}
				variable = prod_instances
				
				set_variable = { name = prod_in_$good$ value = var:prod_dmnd_$good$ }
				change_variable = { name = prod_in_$good$ multiply = prev.var:trade_resolve_trade_tt }
				change_variable = { name = prod_in_$good$ divide = 100 }
				
				set_variable = { name = prod_pay_$good$ value = var:prod_dmnd_$good$ }
				change_variable = { name = prod_pay_$good$ multiply = prev.var:trade_resolve_trade_t }
			}
		}
	}
	else = {
		set_variable = { name = pop_calorie_actual_$good$ value = 0 }
		set_variable = { name = pop_nutrient_actual_$good$ value = 0 }
		set_variable = { name = pop_comfort_actual_$good$ value = 0 }
		set_variable = { name = pop_luxury_actual_$good$ value = 0 }
		
		every_county_province = {
			limit = {
				is_valid_prov = yes
			}
			set_variable = { name = pop_calorie_actual_$good$ value = 0 }
			set_variable = { name = pop_nutrient_actual_$good$ value = 0 }
			set_variable = { name = pop_comfort_actual_$good$ value = 0 }
			set_variable = { name = pop_luxury_actual_$good$ value = 0 }
			
			every_in_list = {
				limit = {
					has_variable = prod_dmnd_$good$
				}
				variable = prod_instances
				
				set_variable = { name = prod_in_$good$ value = 0 }
			}
		}
	}
}

trade_resolve_trade_helper_1_helper = {
	if = {
		limit = {
			has_variable = pop_$type$_$good$
			
			var:pop_$type$_$good$ > 0
		}
		set_variable = { name = pop_$type$_actual_$good$ value = var:pop_$type$_$good$ }
		change_variable = { name = pop_$type$_actual_$good$ multiply = prev.var:trade_resolve_trade_tt }
		change_variable = { name = pop_$type$_actual_$good$ divide = 100 }
		
		set_variable = { name = trade_resolve_trade_t value = var:pop_$type$_$good$ }
		change_variable = { name = trade_resolve_trade_t multiply = prev.var:trade_resolve_trade_t }
		change_variable = { name = pop_pay_$type$ add = var:trade_resolve_trade_t }
	}
	else = {
		set_variable = { name = pop_$type$_actual_$good$ value = 0 }
	}
}

trade_update_price = {
	every_county = {
		limit = {
			is_valid_prov = yes
		}
		^^goods^trade_update_price_helper_0 = { type0 = dmnd type1 = in opr0 = divide opr1 = multiply good = &goods& }^
		^^goods^trade_update_price_helper_0 = { type0 = sply type1 = out opr0 = multiply opr1 = divide good = &goods& }^
		
		remove_variable = trade_update_price_t
	}
	
	every_in_global_list = {
		variable = trade_merchants
		
		^^goods^trade_update_price_helper_1 = { good = &goods& }^
		
		remove_variable = trade_update_price_t
	}
}

trade_update_price_helper_0 = {
	if = {
		limit = {
			has_variable = trade_$type0$_$good$
			
			var:trade_$type0$_$good$ > 0
		}
		if = {
			limit = {
				has_variable = trade_$type1$_$good$
			}
			set_variable = { name = trade_update_price_t value = var:trade_$type1$_$good$ }
		}
		else = {
			set_variable = { name = trade_update_price_t value = 0 }
		}
		
		change_variable = { name = trade_update_price_t multiply = 100 }
		change_variable = { name = trade_update_price_t divide = var:trade_$type0$_$good$ }
		change_variable = { name = trade_update_price_t subtract = 90 }
		
		if = {
			limit = {
				has_variable = trade_update_price_t
				
				var:trade_update_price_t != 0
			}
			if = {
				limit = {
					var:trade_update_price_t > 0
				}
				change_variable = { name = trade_update_price_t divide = 200 }
				change_variable = { name = trade_update_price_t add = 1 }
				change_variable = { name = trade_price_$good$ $opr0$ = var:trade_update_price_t }
			}
			else = {
				change_variable = { name = trade_update_price_t divide = -900 }
				change_variable = { name = trade_update_price_t add = 1 }
				change_variable = { name = trade_price_$good$ $opr1$ = var:trade_update_price_t }
			}
		}
	}
}

trade_update_price_helper_1 = {
	if = {
		limit = {
			has_variable = trade_want_$good$
			
			var:trade_want_$good$ > 0
		}
		set_variable = { name = trade_update_price_t value = var:trade_has_$good$ }
		change_variable = { name = trade_update_price_t multiply = 2 }
		change_variable = { name = trade_update_price_t subtract = var:trade_want_$good$ }
		change_variable = { name = trade_update_price_t divide = var:trade_want_$good$ }
		change_variable = { name = trade_update_price_t divide = 10 }
		
		if = {
			limit = {
				has_variable = trade_update_price_t
				
				var:trade_update_price_t != 0
			}
			if = {
				limit = {
					var:trade_update_price_t > 0
				}
				change_variable = { name = trade_update_price_t add = 1 }
				change_variable = { name = trade_price_$good$ divide = var:trade_update_price_t }
			}
			else = {
				change_variable = { name = trade_update_price_t multiply = -1 }
				change_variable = { name = trade_update_price_t add = 1 }
				change_variable = { name = trade_price_$good$ multiply = var:trade_update_price_t }
			}
		}
	}
}

trade_update_merchant = {
	every_in_global_list = {
		variable = trade_merchants
		
		^^goods^trade_update_merchant_helper = { good = &goods& }^
	}
}

trade_update_merchant_helper = {
	change_variable = { name = trade_want_$good$ multiply = 0.8 }
	change_variable = { name = trade_want_$good$ add = var:trade_out_$good$ }
	change_variable = { name = trade_want_$good$ add = 0.2 }
	
	change_variable = { name = trade_has_$good$ add = var:trade_in_$good$ }
	change_variable = { name = trade_has_$good$ subtract = var:trade_out_$good$ }
	
	if = {
		limit = {
			has_variable = trade_has_$good$
			
			var:trade_has_$good$ > 0
			
			var:trade_has_$good$ = {
				compare_value > prev.var:trade_want_$good$
			}
		}
		set_variable = { name = trade_want_$good$ value = var:trade_has_$good$ }
	}
}