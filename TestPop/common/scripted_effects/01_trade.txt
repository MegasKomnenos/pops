trade_new_merchant = {
	create_character = {
		save_temporary_scope_as = trade_new_merchant_t
		gender = male
		trait = character_not_1
		employer = global_var:arhat
		faith = global_var:arhat.faith
		culture = global_var:arhat.culture
		dynasty = none
	}
	
	add_to_global_variable_list = { name = trade_merchants target = scope:trade_new_merchant_t }
	
	$location$ = {
		set_variable = { name = trade_merchant value = scope:trade_new_merchant_t }
	}
	
	set_variable = { name = trade_new_merchant_t value = $power$ }
	set_variable = { name = trade_new_merchant_tt value = $wealth$ }
	
	scope:trade_new_merchant_t = {
		set_variable = { name = trade_location value = $location$ }
		set_variable = { name = trade_power value = prev.var:trade_new_merchant_t }
		set_variable = { name = trade_wealth value = prev.var:trade_new_merchant_tt }
		
		set_variable = { name = trade_profit value = 0 }
		set_variable = { name = trade_earn value = 0 }
		set_variable = { name = trade_pay value = 0 }
		
		^^goods^
			set_variable = { name = trade_has_&goods& value = 0 }
			set_variable = { name = trade_want_&goods& value = 0 }
			set_variable = { name = trade_price_&goods& value = $location$.county.var:trade_price_&goods& }
		^
		
		set_variable = { name = trade_retire value = 0.5 }
		set_variable = { name = trade_luxury value = 0.5 }
		set_variable = { name = trade_invest value = 1.5 }
	}
	
	remove_variable = trade_new_merchant_t
	remove_variable = trade_new_merchant_tt
}

trade_pop_merchant = {
	remove_list_global_variable = { name = trade_merchants target = this }
	
	var:trade_location = {
		remove_variable = trade_merchant
	}
	
	death = natural
}

trade_set_link = {
	every_in_global_list = {
		variable = trade_merchants
		
		clear_variable_list = trade_link
		array_clear = { name = trade_link }
		
		add_to_global_variable_list = { name = trade_set_link_t target = var:trade_location }
	}
	
	travel_distance_dijkstra_opti = {
		start_list = trade_set_link_t
		start_list_global = yes
		max = 5000
		prev_same = yes
		return_dist = trade_set_link_dist
		return_prev = trade_set_link_prev
		return_list = trade_set_link_list
	}
	
	every_in_global_list = {
		variable = trade_merchants
		
		every_in_global_list = {
			limit = {
				has_variable = trade_set_link_prev
				
				var:trade_set_link_prev = prev.var:trade_location
			}
			variable = trade_set_link_list
			
			every_in_list = {
				limit = {
					has_variable = trade_set_link_prev
					
					NOT = {
						var:trade_set_link_prev = prev.var:trade_set_link_prev
					}
				}
				variable = prov_neighb
				
				set_global_variable = { name = trade_set_link_t value = var:trade_set_link_dist }
				change_global_variable = { name = trade_set_link_t add = prev.var:trade_set_link_dist }
				
				var:trade_set_link_prev.var:trade_merchant = {
					if = {
						limit = {
							OR = {
								NOT = {
									has_variable = trade_set_link_t
								}
								
								var:trade_set_link_t = {
									compare_value > global_var:trade_set_link_t
								}
							}
						}
						set_variable = { name = trade_set_link_t value = global_var:trade_set_link_t }
					}
				}
			}
			every_in_list = {
				limit = {
					has_variable = trade_set_link_prev
					
					NOT = {
						var:trade_set_link_prev = prev.var:trade_set_link_prev
					}
				}
				variable = prov_port
				
				set_global_variable = { name = trade_set_link_t value = var:trade_set_link_dist }
				change_global_variable = { name = trade_set_link_t add = prev.var:trade_set_link_dist }
				
				var:trade_set_link_prev.var:trade_merchant = {
					if = {
						limit = {
							OR = {
								NOT = {
									has_variable = trade_set_link_t
								}
								
								var:trade_set_link_t = {
									compare_value > global_var:trade_set_link_t
								}
							}
						}
						set_variable = { name = trade_set_link_t value = global_var:trade_set_link_t }
					}
				}
			}
		}
		
		every_in_global_list = {
			limit = {
				has_variable = trade_set_link_t
			}
			variable = trade_merchants
			
			if = {
				limit = {
					NOT = {
						this = prev
					}
				}
				prev = {
					add_to_variable_list = { name = trade_link target = prev.var:trade_location }
					array_add = { name = trade_link value = prev.var:trade_set_link_t dec = 10 }
				}
			}
			
			remove_variable = trade_set_link_t
		}
	}
	
	every_in_global_list = {
		variable = trade_merchants
		
		set_variable = { name = trade_set_link_t value = 0 }
		
		every_in_list = {
			variable = trade_link
			
			prev = {
				array_get = { name = trade_link value = var:trade_set_link_t return = trade_set_link_tt dec = 10 }
				
				change_variable = { name = trade_set_link_t add = 1 }
			}
			
			set_variable = { name = trade_set_link_tt value = prev.var:trade_set_link_tt }
			
			set_variable = { name = trade_set_link_t value = var:trade_set_link_tt }
			change_variable = { name = trade_set_link_t divide = -20 }
			change_variable = { name = trade_set_link_t add = prev.var:trade_power }
			change_variable = { name = trade_set_link_t subtract = var:trade_merchant.var:trade_power }
		}
		
		save_temporary_scope_as = trade_set_link_t
		
		set_global_variable = { name = trade_set_link_loop }
		
		while = {
			limit = {
				has_global_variable = trade_set_link_loop
			}
			remove_global_variable = trade_set_link_loop
			
			every_in_list = {
				limit = {
					has_variable = trade_set_link_t
					
					var:trade_set_link_t > 0
				}
				variable = trade_link
				
				set_global_variable = { name = trade_set_link_loop }
				
				var:trade_merchant = {
					set_variable = { name = trade_set_link_t value = prev.var:trade_set_link_t }
					set_variable = { name = trade_set_link_tt value = prev.var:trade_set_link_tt }
					set_variable = { name = trade_set_link_ttt value = 0 }
		
					every_in_list = {
						limit = {
							NOT = {
								this.var:trade_merchant = scope:trade_set_link_t
							}
						}
						variable = trade_link
						
						
						prev = {
							array_get = { name = trade_link value = var:trade_set_link_ttt return = trade_set_link_tttt dec = 10 }
							
							change_variable = { name = trade_set_link_ttt add = 1 }
						}
						
						set_variable = { name = trade_set_link_tttt value = prev.var:trade_set_link_tt }
						change_variable = { name = trade_set_link_tttt add = prev.var:trade_set_link_tttt }
						
						set_variable = { name = trade_set_link_ttt value = prev.var:trade_set_link_tttt }
						change_variable = { name = trade_set_link_ttt divide = -20 }
						change_variable = { name = trade_set_link_ttt add = prev.var:trade_set_link_t }
						change_variable = { name = trade_set_link_ttt subtract = var:trade_merchant.var:trade_power }
						
						if = {
							limit = {
								NOT = {
									has_variable = trade_set_link_tt
								}
							}
							set_variable = { name = trade_set_link_t value = var:trade_set_link_ttt }
							set_variable = { name = trade_set_link_tt value = var:trade_set_link_tttt }
							
							scope:trade_set_link_t = {
								add_to_variable_list = { name = trade_link target = prev }
								array_add = { name = trade_link value = prev.var:trade_set_link_tt dec = 10 }
							}
						}
						else_if = {
							limit = {
								var:trade_set_link_tt = {
									compare_value > prev.var:trade_set_link_tttt
								}
							}
							set_variable = { name = trade_set_link_t value = var:trade_set_link_ttt }
							set_variable = { name = trade_set_link_tt value = var:trade_set_link_tttt }
							
							save_temporary_scope_as = trade_set_link_tt
							
							scope:trade_set_link_t = {
								set_global_variable = { name = trade_set_link_t value = 0 }
								
								every_in_list = {
									variable = trade_link
									
									if = {
										limit = {
											this = scope:trade_set_link_tt
										}
										prev = {
											remove_list_variable = { name = trade_link target = prev }
											
											ordered_in_list = {
												variable = array_trade_link
												position = global_var:trade_set_link_t.compare_value
												
												prev = {
													remove_list_variable = { name = array_trade_link target = prev }
												}
											}
										}
									}
									else = {
										change_global_variable = { name = trade_set_link_t add = 1 }
									}
								}
								
								add_to_variable_list = { name = trade_link target = prev }
								array_add = { name = trade_link value = prev.var:trade_set_link_tt dec = 10 }
							}
						}
					}
				}
				
				set_variable = { name = trade_set_link_t value = -1 }
			}
		}
	}
	
	every_in_global_list = {
		variable = trade_merchants
		
		remove_variable = trade_set_link_t
		remove_variable = trade_set_link_tt
		remove_variable = trade_set_link_ttt
		remove_variable = trade_set_link_tttt
	}
	every_in_global_list = {
		variable = trade_set_link_list
		
		remove_variable = trade_set_link_checked
		remove_variable = trade_set_link_dist
		remove_variable = trade_set_link_prev
		
		remove_variable = trade_set_link_t
		remove_variable = trade_set_link_tt
		remove_variable = trade_set_link_ttt
		remove_variable = trade_set_link_tttt
	}
	
	clear_global_variable_list = trade_set_link_list
	clear_global_variable_list = trade_set_link_t
	remove_global_variable = trade_set_link_t
}

trade_set_core = {
	clear_variable_list = trade_core
	array_clear = { name = trade_core }
	
	travel_distance_dijkstra_opti = {
		start = var:trade_location
		max = 400
		return_dist = trade_set_core_dist
		return_prev = trade_set_core_prev
		return_list = trade_set_core_list
	}
	
	every_county = {
		limit = {
			is_valid_prov = yes
					
			any_county_province = {
				has_variable = trade_set_core_dist
			}
		}
		ordered_county_province = {
			limit = {
				has_variable = trade_set_core_dist
			}
			order_by = trade_do_trade_order_value_2
			position = 0
			
			prev = {
				set_variable = { name = trade_set_core_dist value = prev.var:trade_set_core_dist }
			}
		}

		prev = {
			add_to_variable_list = { name = trade_core target = prev }
			array_add = { name = trade_core value = prev.var:trade_set_core_dist dec = 10 }
		}
		
		remove_variable = trade_set_core_dist
	}
	
	every_in_global_list = {
		variable = trade_set_core_list
		
		remove_variable = trade_set_core_dist
		remove_variable = trade_set_core_prev
	}
	
	clear_global_variable_list = trade_set_core_list
}

trade_do_trade_helper_3 = {
	set_variable = { name = trade_$type$_pay value = var:trade_$type$ }
	change_variable = { name = trade_$type$_pay multiply = var:trade_wealth }
	change_variable = { name = trade_$type$_pay divide = 100 }
	
	set_variable = { name = trade_do_trade_t value = 0 }
	
	^^goods^
		set_variable = { name = trade_$type$_&goods& value = trade_$type$_&goods& }
		
		if = {
			limit = {
				has_variable = trade_$type$_&goods&
				
				var:trade_$type$_&goods& > 0
			}
			change_variable = { name = trade_$type$_&goods& multiply = 100 }
			change_variable = { name = trade_$type$_&goods& divide = var:trade_price_&goods& }
			change_variable = { name = trade_$type$_&goods& multiply = var:trade_$type$_&goods& }
			change_variable = { name = trade_$type$_&goods& divide = 100 }
			change_variable = { name = trade_do_trade_t add = var:trade_$type$_&goods& }
		}
		else = {
			remove_variable = trade_$type$_&goods&
		}
	^
	^^goods^
		if = {
			limit = {
				has_variable = trade_$type$_&goods&
				
				var:trade_$type$_&goods& > 0
			}
			change_variable = { name = trade_$type$_&goods& multiply = 100 }
			change_variable = { name = trade_$type$_&goods& divide = var:trade_do_trade_t }
		}
	^
	
	set_variable = { name = trade_do_trade_t value = 0 }
	
	^^goods^
		if = {
			limit = {
				has_variable = trade_$type$_&goods&
				
				var:trade_$type$_&goods& > 0
			}
			set_variable = { name = trade_do_trade_tt value = var:trade_$type$_&goods& }
			change_variable = { name = trade_do_trade_tt multiply = var:trade_price_&goods& }
			change_variable = { name = trade_do_trade_tt divide = 100 }
			change_variable = { name = trade_do_trade_t add = var:trade_do_trade_tt }
		}
	^
	
	set_variable = { name = trade_do_trade_tt value = var:trade_$type$_pay }
	change_variable = { name = trade_do_trade_tt divide = var:trade_do_trade_t }
	
	^^goods^
		if = {
			limit = {
				has_variable = trade_$type$_&goods&
				
				var:trade_$type$_&goods& > 0
			}
			change_variable = { name = trade_$type$_&goods& multiply = var:trade_do_trade_tt }
			change_variable = { name = trade_$type$_&goods& divide = 100 }
		}
	^
}

trade_rank_up_handler = {
	if = {
		limit = {
			is_ruler = yes
			is_landed = yes
			
			OR = {
				NOT = {
					has_variable = trade_earn
				}
				NOT = {
					has_variable = trade_pay
				}
			}
		}
		set_variable = { name = trade_earn value = 0 }
		set_variable = { name = trade_pay value = 0 }
		
		^^goods^
			if = { limit = { NOT = { has_variable = trade_in_&goods& } } set_variable = { name = trade_in_&goods& value = 0 } }
			if = { limit = { NOT = { has_variable = trade_out_&goods& } } set_variable = { name = trade_out_&goods& value = 0 } }
			if = { limit = { NOT = { has_variable = trade_earn_&goods& } } set_variable = { name = trade_earn_&goods& value = 0 } }
			if = { limit = { NOT = { has_variable = trade_pay_&goods& } } set_variable = { name = trade_pay_&goods& value = 0 } }
			if = { limit = { NOT = { has_variable = trade_has_&goods& } } set_variable = { name = trade_has_&goods& value = 0 } }
			if = { limit = { NOT = { has_variable = trade_want_&goods& } } set_variable = { name = trade_want_&goods& value = 0 } }
			if = { limit = { NOT = { has_variable = trade_price_&goods& } } set_variable = { name = trade_price_&goods& value = capital_county.var:trade_price_&goods& } }
			if = { limit = { NOT = { has_variable = trade_sply_&goods& } } set_variable = { name = trade_sply_&goods& value = 0 } }
			if = { limit = { NOT = { has_variable = trade_dmnd_&goods& } } set_variable = { name = trade_dmnd_&goods& value = 0 } }
		^
	}
}

trade_death_handler = {
	if = {
		limit = {
			is_ruler = yes
		}
		primary_heir = {
			if = {
				limit = {
					is_ruler = no
				}
				^^goods^
					clear_variable_list = trade_dat_&goods&
					array_clear = { name = trade_dat_&goods& }
					
					set_variable = { name = trade_in_&goods& value = 0 }
					set_variable = { name = trade_out_&goods& value = 0 }
					set_variable = { name = trade_earn_&goods& value = 0 }
					set_variable = { name = trade_pay_&goods& value = 0 }
					set_variable = { name = trade_has_&goods& value = 0 }
					set_variable = { name = trade_want_&goods& value = 0 }
					set_variable = { name = trade_price_&goods& value = 0 }
					set_variable = { name = trade_sply_&goods& value = 0 }
					set_variable = { name = trade_dmnd_&goods& value = 0 }
				^
			}
			
			^^goods^
				prev = {
					set_variable = { name = trade_death_handler_t value = 0 }
					
					save_temporary_scope_as = trade_death_handler_t
					
					every_in_list = {
						variable = trade_dat_&goods&
						
						save_temporary_scope_as = trade_death_handler_tt
						
						prev.primary_heir = {
							if = {
								limit = {
									is_target_in_variable_list = { name = trade_dat_&goods& target = prev }
								}
								set_global_variable = { name = trade_death_handler_t value = 0 }
								
								every_in_list = {
									limit = {
										has_global_variable = trade_death_handler_t
									}
									variable = trade_dat_&goods&
									
									if = {
										limit = {
											this = scope:trade_death_handler_tt
										}
										prev = {
											remove_list_variable = { name = trade_dat_&goods& target = prev }
											add_to_variable_list = { name = trade_dat_&goods& target = prev }
											
											scope:trade_death_handler_t = {
												array_get = { name = trade_dat_&goods& value = var:trade_death_handler_t return = trade_death_handler_tt dec = 10 }
											}
											
											array_change = { name = trade_dat_&goods& ind = global_var:trade_death_handler_t add = scope:trade_death_handler_t.var:trade_death_handler_tt dec = 10 }
										}
										
										remove_global_variable = trade_death_handler_t
									}
									else = {
										change_global_variable = { name = trade_death_handler_t add = 1 }
									}
								}
							}
							else = {
								add_to_variable_list = { name = trade_dat_&goods& target = prev }
								
								scope:trade_death_handler_t = {
									array_get = { name = trade_dat_&goods& value = var:trade_death_handler_t return = trade_death_handler_tt dec = 10 }
								}
								
								array_add = { name = trade_dat_&goods& value = scope:trade_death_handler_t.var:trade_death_handler_tt dec = 10 }
							}
						}
						
						prev = {
							change_variable = { name = trade_death_handler_t add = 1 }
						}
					}
					
					remove_variable = trade_death_handler_t
					remove_variable = trade_death_handler_tt
				}
				
				prev = {
					change_variable = { name = trade_price_&goods& multiply = var:trade_has_&goods& }
				}
				
				change_variable = { name = trade_price_&goods& multiply = var:trade_has_&goods& }
				change_variable = { name = trade_price_&goods& add = prev.var:trade_price_&goods& }
				
				change_variable = { name = trade_in_&goods& add = prev.var:trade_in_&goods& }
				change_variable = { name = trade_out_&goods& add = prev.var:trade_out_&goods& }
				change_variable = { name = trade_earn_&goods& add = prev.var:trade_earn_&goods& }
				change_variable = { name = trade_pay_&goods& add = prev.var:trade_pay_&goods& }
				change_variable = { name = trade_has_&goods& add = prev.var:trade_has_&goods& }
				change_variable = { name = trade_want_&goods& add = prev.var:trade_want_&goods& }
				change_variable = { name = trade_sply_&goods& add = prev.var:trade_sply_&goods& }
				change_variable = { name = trade_dmnd_&goods& add = prev.var:trade_dmnd_&goods& }
				
				if = {
					limit = {
						has_variable = trade_has_&goods&
						
						var:trade_has_&goods& > 0
					}
					change_variable = { name = trade_price_&goods& divide = var:trade_has_&goods& }
				}
			^
		}
	}
}

trade_do_trade = {
	every_county = {
		limit = {
			is_valid_prov = yes
		}
		^^goods^
			clear_variable_list = trade_dat_&goods&
			array_clear = { name = trade_dat_&goods& }
			
			set_variable = { name = trade_sply_&goods& value = 0 }
			set_variable = { name = trade_dmnd_&goods& value = 0 }
		^
		
		trade_do_trade_helper_0 = yes
		
		^^goods^trade_do_trade_helper_1 = { good = &goods& }^
	}
	
	every_ruler = {
		limit = {
			is_character = yes
			is_landed = yes
		}
		^^goods^
			clear_variable_list = trade_dat_&goods&
			array_clear = { name = trade_dat_&goods& }
			
			set_variable = { name = trade_in_&goods& value = 0 }
			set_variable = { name = trade_out_&goods& value = 0 }
			set_variable = { name = trade_earn_&goods& value = 0 }
			set_variable = { name = trade_pay_&goods& value = 0 }
			
			if = {
				limit = {
					NOT = {
						has_variable = trade_sply_&goods&
					}
				}
				set_variable = { name = trade_sply_&goods& value = 0 }
			}
			if = {
				limit = {
					NOT = {
						has_variable = trade_dmnd_&goods&
					}
				}
				set_variable = { name = trade_dmnd_&goods& value = 0 }
			}
		^
		
		capital_county = {
			set_variable = { name = trade_do_trade_capital value = prev }
		}
	}
	
	every_in_global_list = {
		variable = trade_merchants
		
		trade_do_trade_helper_3 = { type = luxury }
		trade_do_trade_helper_3 = { type = invest }
		
		set_variable = { name = trade_luxury_pay value = 0 }
		set_variable = { name = trade_invest_pay value = 0 }
		
		change_variable = { name = trade_power multiply = 0.933 }
		
		^^goods^
			clear_variable_list = trade_dat_&goods&
			array_clear = { name = trade_dat_&goods& }
			
			set_variable = { name = trade_in_&goods& value = 0 }
			set_variable = { name = trade_out_&goods& value = 0 }
			
			set_variable = { name = trade_earn_&goods& value = 0 }
			set_variable = { name = trade_pay_&goods& value = 0 }
			
			set_variable = { name = trade_dmnd_&goods& value = var:trade_want_&goods& }
			change_variable = { name = trade_dmnd_&goods& subtract = var:trade_has_&goods& }
			change_variable = { name = trade_dmnd_&goods& divide = 2 }
			
			set_variable = { name = trade_sply_&goods& value = var:trade_has_&goods& }
			change_variable = { name = trade_sply_&goods& divide = 2 }
			
			set_variable = { name = trade_do_trade_t value = 0 }
			
			if = {
				limit = {
					has_variable = trade_luxury_&goods&
					
					var:trade_luxury_&goods& > 0
				}
				change_variable = { name = trade_dmnd_&goods& add = var:trade_luxury_&goods& }
				change_variable = { name = trade_do_trade_t add = var:trade_luxury_&goods& }
			}
			if = {
				limit = {
					has_variable = trade_invest_&goods&
					
					var:trade_invest_&goods& > 0
				}
				change_variable = { name = trade_dmnd_&goods& add = var:trade_invest_&goods& }
				change_variable = { name = trade_do_trade_t add = var:trade_invest_&goods& }
			}
			
			if = {
				limit = {
					has_variable = trade_do_trade_t
					
					var:trade_do_trade_t > 0
				}
				if = {
					limit = {
						OR = {
							NOT = {
								has_variable = trade_sply_&goods&
							}
							
							var:trade_sply_&goods& = {
								compare_value < prev.var:trade_do_trade_t
							}
						}
					}
					set_variable = { name = trade_out_&goods& value = var:trade_sply_&goods& }
					
					set_variable = { name = trade_do_trade_tt value = var:trade_sply_&goods& }
					change_variable = { name = trade_do_trade_tt multiply = 100 }
					change_variable = { name = trade_do_trade_tt divide = var:trade_do_trade_t }
					
					if = {
						limit = {
							has_variable = trade_luxury_&goods&
							
							var:trade_luxury_&goods& > 0
						}
						set_variable = { name = trade_do_trade_t value = var:trade_luxury_&goods& }
						change_variable = { name = trade_do_trade_t multiply = var:trade_do_trade_tt }
						change_variable = { name = trade_do_trade_t divide = 100 }
						change_variable = { name = trade_do_trade_t multiply = var:trade_price_&goods& }
						change_variable = { name = trade_luxury_pay add = var:trade_do_trade_t }
					}
					if = {
						limit = {
							has_variable = trade_invest_&goods&
							
							var:trade_invest_&goods& > 0
						}
						set_variable = { name = trade_invest_pay_&goods& value = var:trade_invest_&goods& }
						change_variable = { name = trade_invest_pay_&goods& multiply = var:trade_do_trade_tt }
						change_variable = { name = trade_invest_pay_&goods& divide = 100 }
						set_variable = { name = trade_do_trade_t value = var:trade_invest_pay_&goods& }
						change_variable = { name = trade_do_trade_t multiply = trade_invest_&goods& }
						change_variable = { name = trade_power add = var:trade_do_trade_t }
						change_variable = { name = trade_invest_pay_&goods& multiply = var:trade_price_&goods& }
						change_variable = { name = trade_invest_pay add = var:trade_invest_pay_&goods& }
					}
				}
				else = {
					change_variable = { name = trade_out_&goods& add = var:trade_do_trade_t }
					
					if = {
						limit = {
							has_variable = trade_luxury_&goods&
							
							var:trade_luxury_&goods& > 0
						}
						set_variable = { name = trade_do_trade_t value = var:trade_luxury_&goods& }
						change_variable = { name = trade_do_trade_t multiply = var:trade_price_&goods& }
						change_variable = { name = trade_luxury_pay add = var:trade_do_trade_t }
					}
					if = {
						limit = {
							has_variable = trade_invest_&goods&
							
							var:trade_invest_&goods& > 0
						}
						set_variable = { name = trade_invest_pay_&goods& value = var:trade_invest_&goods& }
						set_variable = { name = trade_do_trade_t value = var:trade_invest_pay_&goods& }
						change_variable = { name = trade_do_trade_t multiply = trade_invest_&goods& }
						change_variable = { name = trade_power add = var:trade_do_trade_t }
						change_variable = { name = trade_invest_pay_&goods& multiply = var:trade_price_&goods& }
						change_variable = { name = trade_invest_pay add = var:trade_invest_pay_&goods& }
					}
				}
			}
			else = {
				remove_variable = trade_invest_pay_&goods&
			}
		^
		
		set_variable = { name = trade_power_t value = var:trade_power }
		change_variable = { name = trade_power_t multiply = 5 }
	}
	
	set_global_variable = { name = trade_do_trade_loop }
	
	while = {
		limit = {
			has_global_variable = trade_do_trade_loop
		}
		count = 100000
		
		remove_global_variable = trade_do_trade_loop
		
		ordered_in_global_list = {
			limit = {
				has_variable = trade_power_t
			}
			variable = trade_merchants
			order_by = trade_do_trade_order_value_0
			position = 0
			
			set_global_variable = { name = trade_do_trade_loop }
			set_global_variable = { name = trade_do_trade_select value = this }
			
			set_global_variable = { name = trade_do_trade_t value = 0 }
			
			every_in_list = {
				variable = trade_core
				
				add_to_global_variable_list = { name = trade_do_trade_list target = this }
				
				prev = {
					array_get = { name = trade_core value = global_var:trade_do_trade_t return = trade_do_trade_t dec = 10 }
				}
				
				set_variable = { name = trade_do_trade_dist value = prev.var:trade_do_trade_t }
				
				if = {
					limit = {
						has_variable = trade_do_trade_capital
					}
					var:trade_do_trade_capital = {
						add_to_global_variable_list = { name = trade_do_trade_list target = this }
						
						set_variable = { name = trade_do_trade_dist value = prev.var:trade_do_trade_dist }
					}
				}
				
				change_global_variable = { name = trade_do_trade_t add = 1 }
			}
			
			set_global_variable = { name = trade_do_trade_t value = 0 }
			
			every_in_list = {
				variable = trade_link
				
				if = {
					limit = {
						has_variable = trade_merchant
					}
					prev = {
						array_get = { name = trade_link value = global_var:trade_do_trade_t return = trade_do_trade_t dec = 10 }
					}
					
					var:trade_merchant = {
						add_to_global_variable_list = { name = trade_do_trade_list target = this }
						
						set_variable = { name = trade_do_trade_dist value = global_var:trade_do_trade_select.var:trade_do_trade_t }
						change_variable = { name = trade_do_trade_dist divide = 3 }
						change_variable = { name = trade_do_trade_dist add = 266.667 }
					}
				}
				
				change_global_variable = { name = trade_do_trade_t add = 1 }
			}
			
			every_in_global_list = {
				variable = trade_do_trade_list
				
				set_variable = { name = trade_cost value = var:trade_do_trade_dist }
				change_variable = { name = trade_cost divide = 40 }
				change_variable = { name = trade_cost add = 1 }
				change_variable = { name = trade_cost divide = 20 }
			}
			
			^^goods^
				set_variable = { name = trade_sum_buy_&goods& value = 0 }
				set_variable = { name = trade_sum_sell_&goods& value = 0 }
				
				set_variable = { name = trade_buy_&goods& value = var:trade_dmnd_&goods& }
				change_variable = { name = trade_buy_&goods& subtract = var:trade_in_&goods& }
				
				set_variable = { name = trade_sell_&goods& value = var:trade_sply_&goods& }
				change_variable = { name = trade_sell_&goods& subtract = var:trade_out_&goods& }
				
				if = {
					limit = {
						var:trade_buy_&goods& < 0
					}
					set_variable = { name = trade_buy_&goods& value = 0 }
				}
				if = {
					limit = {
						var:trade_sell_&goods& < 0
					}
					set_variable = { name = trade_sell_&goods& value = 0 }
				}
			^
			
			every_in_global_list = {
				variable = trade_do_trade_list
				
				^^goods^
					if = {
						limit = {
							var:trade_price_&goods& = { 
								compare_value = global_var:trade_do_trade_select.var:trade_price_&goods& 
							} 
						}
						set_variable = { name = trade_sell_&goods& value = 0 } 
						set_variable = { name = trade_buy_&goods& value = 0 } 
					}
					else = {
						if = {
							limit = {
								var:trade_price_&goods& = { 
									compare_value > global_var:trade_do_trade_select.var:trade_price_&goods& 
								}
							}
							set_variable = { name = trade_sell_&goods& value = 0 } 
							
							set_variable = { name = trade_buy_&goods& value = var:trade_dmnd_&goods& }
							change_variable = { name = trade_buy_&goods& subtract = var:trade_in_&goods& }
							
							if = {
								limit = {
									var:trade_buy_&goods& < 0
								}
								set_variable = { name = trade_buy_&goods& value = 0 }
							}
						}
						else = {
							set_variable = { name = trade_buy_&goods& value = 0 } 
							
							set_variable = { name = trade_sell_&goods& value = var:trade_sply_&goods& }
							change_variable = { name = trade_sell_&goods& subtract = var:trade_out_&goods& }
							
							if = {
								limit = {
									var:trade_sell_&goods& < 0
								}
								set_variable = { name = trade_sell_&goods& value = 0 }
							}
						}
					}
					
					if = {
						limit = {
							OR = {
								AND = {
									has_variable = trade_sell_&goods&
									
									var:trade_sell_&goods& > 0
								}
								AND = {
									has_variable = trade_buy_&goods&
									
									var:trade_buy_&goods& > 0
								}
							}
						}
						set_variable = { name = trade_point_&goods& value = var:trade_price_&goods& }
						change_variable = { name = trade_point_&goods& subtract = prev.var:trade_price_&goods& }
						
						if = {
							limit = {
								has_variable = trade_point_&goods&
								
								var:trade_point_&goods& < 0
							}
							change_variable = { name = trade_point_&goods& multiply = -1 }
						}
						
						change_variable = { name = trade_point_&goods& multiply = 100 }
						change_variable = { name = trade_point_&goods& add = 1 }
						change_variable = { name = trade_point_&goods& divide = trade_power_cost_&goods& }
						change_variable = { name = trade_point_&goods& divide = var:trade_cost }
						
						if = {
							limit = {
								has_variable = task_manage_stockpile
							}
							change_variable = { name = trade_point_&goods& multiply = var:task_manage_stockpile.var:task_time_in }
							change_variable = { name = trade_point_&goods& divide = 100 }
						}
					}
					else = {
						remove_variable = trade_point_&goods&
					}
				^
				
				prev = {
					^^goods^
						change_variable = { name = trade_sum_buy_&goods& add = prev.var:trade_buy_&goods& }
						change_variable = { name = trade_sum_sell_&goods& add = prev.var:trade_sell_&goods& }
					^
				}
			}
			
			^^goods^trade_do_trade_helper_2 = { good = &goods& type0 = buy type1 = sell }^
			^^goods^trade_do_trade_helper_2 = { good = &goods& type0 = sell type1 = buy }^
			
			set_variable = { name = trade_cost value = 0 }
			
			every_in_global_list = {
				variable = trade_do_trade_list
				
				set_variable = { name = trade_do_trade_t value = 0 }
				
				^^goods^
					set_variable = { name = trade_do_trade_tt value = var:trade_buy_&goods& }
					change_variable = { name = trade_do_trade_tt add = var:trade_sell_&goods& }
					change_variable = { name = trade_do_trade_tt multiply = trade_power_cost_&goods& }
					change_variable = { name = trade_do_trade_t add = var:trade_do_trade_tt }
				^
				
				change_variable = { name = trade_do_trade_t multiply = var:trade_cost }
				
				prev = {
					change_variable = { name = trade_cost add = prev.var:trade_do_trade_t }
				}
			}
			
			if = {
				limit = {
					has_variable = trade_cost
				
					var:trade_cost = {
						compare_value > prev.var:trade_power_t
					}
				}
				set_variable = { name = trade_do_trade_t value = 0.001 }
		
				every_in_global_list = {
					variable = trade_do_trade_list
					
					^^goods^
						if = {
							limit = {
								has_variable = trade_point_&goods&
								
								var:trade_point_&goods& > 0
								
								var:trade_point_&goods& = {
									compare_value > global_var:trade_do_trade_select.var:trade_do_trade_t
								}
							}
							prev = {
								set_variable = { name = trade_do_trade_t value = prev.var:trade_point_&goods& }
							}
						}
					^
				}

				every_in_global_list = {
					variable = trade_do_trade_list
					
					set_variable = { name = trade_do_trade_t value = 0 }
					
					^^goods^
						if = {
							limit = {
								has_variable = trade_point_&goods&
								
								var:trade_point_&goods& > 0
							}
							set_variable = { name = trade_do_trade_t_&goods& value = var:trade_point_&goods& }
							change_variable = { name = trade_do_trade_t_&goods& multiply = 10 }
							change_variable = { name = trade_do_trade_t_&goods& divide = prev.var:trade_do_trade_t }
							change_variable = { name = trade_do_trade_t add = var:trade_do_trade_t_&goods& }
							set_variable = { name = trade_do_trade_tt_&goods& value = 0 }
							set_variable = { name = trade_do_trade_ttt_&goods& value = 0 }
						}
						else = {
							remove_variable = trade_do_trade_t_&goods&
							remove_variable = trade_do_trade_ttt_&goods&
						}
					^
					
					if = {
						limit = {
							has_variable = trade_do_trade_t
							
							var:trade_do_trade_t > 0
						}
						add_to_global_variable_list = { name = trade_do_trade_t target = this }
					}
				}

				set_variable = { name = trade_do_trade_t value = 0 }

				every_in_global_list = {
					variable = trade_do_trade_t
					
					prev = {
						change_variable = { name = trade_do_trade_t add = prev.var:trade_do_trade_t }
					}
				}

				set_variable = { name = trade_do_trade_tt value = var:trade_power_t }

				while = {
					limit = {
						has_variable = trade_do_trade_t
						has_variable = trade_do_trade_tt
						
						var:trade_do_trade_t > 0
						var:trade_do_trade_tt > 0
					}
					set_variable = { name = trade_do_trade_ttt value = var:trade_do_trade_tt }
					change_variable = { name = trade_do_trade_ttt multiply = 100 }
					change_variable = { name = trade_do_trade_ttt divide = var:trade_do_trade_t }
					
					every_in_global_list = {
						variable = trade_do_trade_t
						
						set_variable = { name = trade_do_trade_tt value = var:trade_do_trade_t }
						change_variable = { name = trade_do_trade_tt multiply = prev.var:trade_do_trade_ttt }
						change_variable = { name = trade_do_trade_tt divide = 100 }
						change_variable = { name = trade_do_trade_tt divide = var:trade_cost }
					}
					
					set_variable = { name = trade_do_trade_ttt value = 0 }
					
					every_in_global_list = {
						variable = trade_do_trade_t
						
						set_variable = { name = trade_do_trade_ttt value = var:trade_do_trade_tt }
						change_variable = { name = trade_do_trade_ttt multiply = 100 }
						change_variable = { name = trade_do_trade_ttt divide = var:trade_do_trade_t }
						
						^^goods^
							if = {
								limit = {
									has_variable = trade_do_trade_t_&goods&
									var:trade_do_trade_t_&goods& > 0
								}
								set_variable = { name = trade_do_trade_ttt_&goods& value = var:trade_do_trade_t_&goods& }
								change_variable = { name = trade_do_trade_ttt_&goods& multiply = var:trade_do_trade_ttt }
								change_variable = { name = trade_do_trade_ttt_&goods& divide = trade_power_cost_&goods& }
								change_variable = { name = trade_do_trade_ttt_&goods& divide = 100 }
								change_variable = { name = trade_do_trade_tt_&goods& add = var:trade_do_trade_ttt_&goods& }
							}
						^
						
						set_variable = { name = trade_do_trade_ttt value = 0 }
						
						^^goods^
							if = {
								limit = {
									has_variable = trade_do_trade_ttt_&goods&
									var:trade_do_trade_ttt_&goods& > 0
								}
								if = {
									limit = {
										var:trade_do_trade_tt_&goods& = {
											compare_value >= prev.var:trade_buy_&goods&
											compare_value >= prev.var:trade_sell_&goods&
										}
									}
									change_variable = { name = trade_do_trade_ttt_&goods& subtract = var:trade_do_trade_tt_&goods& }
									change_variable = { name = trade_do_trade_ttt_&goods& add = var:trade_buy_&goods& }
									change_variable = { name = trade_do_trade_ttt_&goods& add = var:trade_sell_&goods& }
									
									set_variable = { name = trade_do_trade_tt_&goods& value = var:trade_buy_&goods& }
									change_variable = { name = trade_do_trade_tt_&goods& add = var:trade_sell_&goods& }
									
									prev = {
										change_variable = { name = trade_do_trade_t subtract = prev.var:trade_do_trade_t_&goods& }
									}
									
									change_variable = { name = trade_do_trade_t subtract = var:trade_do_trade_t_&goods& }
									
									if = {
										limit = {
											OR = {
												NOT = {
													has_variable = trade_do_trade_t
												}
												
												var:trade_do_trade_t = 0
											}
										}
										remove_list_global_variable = { name = trade_do_trade_t target = this }
									}
									
									remove_variable = trade_do_trade_t_&goods&
								}
								
								change_variable = { name = trade_do_trade_ttt_&goods& multiply = trade_power_cost_&goods& }
								change_variable = { name = trade_do_trade_ttt add = var:trade_do_trade_ttt_&goods& }
								
								remove_variable = trade_do_trade_ttt_&goods&
							}
						^
						
						change_variable = { name = trade_do_trade_ttt multiply = var:trade_cost }
						
						prev = {
							change_variable = { name = trade_do_trade_ttt add = prev.var:trade_do_trade_ttt }
						}
					}
					
					if = {
						limit = {
							OR = {
								NOT = {
									has_variable = trade_do_trade_ttt
								}
								
								var:trade_do_trade_ttt < 2.5
							}
						}
						set_variable = { name = trade_do_trade_tt value = 0 }
					}
					else = {
						change_variable = { name = trade_do_trade_tt subtract = var:trade_do_trade_ttt }
					}
				}
				
				clear_global_variable_list = trade_do_trade_t

				every_in_global_list = {
					variable = trade_do_trade_list
					
					^^goods^
						if = {
							limit = {
								has_variable = trade_point_&goods&
								
								var:trade_point_&goods& > 0
							}
							if = {
								limit = {
									var:trade_buy_&goods& > 0
								}
								set_variable = { name = trade_buy_&goods& value = var:trade_do_trade_tt_&goods& }
							}
							else = {
								set_variable = { name = trade_sell_&goods& value = var:trade_do_trade_tt_&goods& }
							}
						}
					^
				}
			}
			
			every_in_global_list = {
				variable = trade_do_trade_list
				
				save_temporary_scope_as = trade_do_trade_select
				
				^^goods^
					if = {
						limit = {	
							OR = {
								AND = {
									has_variable = trade_buy_&goods&
									
									var:trade_buy_&goods& > 0.1
								}
								AND = {
									has_variable = trade_sell_&goods&
									
									var:trade_sell_&goods& > 0.1
								}
							}
						}
						set_variable = { name = trade_do_trade_t value = 0 }
						
						if = {
							limit = {
								has_variable = trade_buy_&goods&
									
								var:trade_buy_&goods& > 0.1
							}
							change_variable = { name = trade_do_trade_t add = var:trade_buy_&goods& }
						}
						else = {
							change_variable = { name = trade_do_trade_t subtract = var:trade_sell_&goods& }
						}
						
						if = {
							limit = {
								has_variable_list = trade_dat_&goods&
								
								is_target_in_variable_list = { name = trade_dat_&goods& target = prev.var:trade_location }
							}
							set_global_variable = { name = trade_do_trade_t value = 0 }
							set_global_variable = { name = trade_do_trade_tt }
							
							every_in_list = {
								limit = {
									has_global_variable = trade_do_trade_tt
								}
								variable = trade_dat_&goods&
								
								if = {
									limit = {
										has_variable = trade_merchant
										
										var:trade_merchant = global_var:trade_do_trade_select
									}
									remove_global_variable = trade_do_trade_tt
									
									prev = {
										remove_list_variable = { name = trade_dat_&goods& target = prev }
										array_change = { name = trade_dat_&goods& ind = global_var:trade_do_trade_t subtract = var:trade_do_trade_t dec = 10 }
										add_to_variable_list = { name = trade_dat_&goods& target = prev }
									}
								}
								else = {
									change_global_variable = { name = trade_do_trade_t add = 1 }
								}
							}
							
							prev = {
								set_global_variable = { name = trade_do_trade_t value = 0 }
								set_global_variable = { name = trade_do_trade_tt }
								
								every_in_list = {
									limit = {
										has_global_variable = trade_do_trade_tt
									}
									variable = trade_dat_&goods&
									
									if = {
										limit = {
											has_variable = trade_merchant
											
											var:trade_merchant = scope:trade_do_trade_select
										}
										remove_global_variable = trade_do_trade_tt
										
										prev = {
											remove_list_variable = { name = trade_dat_&goods& target = prev }
											array_change = { name = trade_dat_&goods& ind = global_var:trade_do_trade_t add = scope:trade_do_trade_select.var:trade_do_trade_t dec = 10 }
											add_to_variable_list = { name = trade_dat_&goods& target = prev }
										}
									}
									else = {
										change_global_variable = { name = trade_do_trade_t add = 1 }
									}
								}
							}
						}
						else = {
							prev = {
								array_add = { name = trade_dat_&goods& value = scope:trade_do_trade_select.var:trade_do_trade_t dec = 10 }
								
								if = {
									limit = {
										prev = {
											has_variable = trade_location
										}
									}
									add_to_variable_list = { name = trade_dat_&goods& target = prev.var:trade_location }
								}
								else = {
									add_to_variable_list = { name = trade_dat_&goods& target = prev }
								}
							}
							
							change_variable = { name = trade_do_trade_t multiply = -1 }
							
							array_add = { name = trade_dat_&goods& value = var:trade_do_trade_t dec = 10 }
							add_to_variable_list = { name = trade_dat_&goods& target = prev.var:trade_location }
						}
					}
				^
			}
				
			every_in_global_list = {
				variable = trade_do_trade_list
				
				^^goods^trade_do_trade_helper_4 = { good = &goods& }^
				
				remove_variable = trade_do_trade_dist
			}
			
			remove_global_variable = trade_do_trade_select
			clear_global_variable_list = trade_do_trade_list
			
			remove_variable = trade_power_t
		}
	}
	
	every_county = {
		limit = {
			is_valid_prov = yes
		}
		^^goods^
			remove_variable = trade_buy_&goods&
			remove_variable = trade_sell_&goods&
			remove_variable = trade_point_&goods&
			remove_variable = trade_sum_buy_&goods&
			remove_variable = trade_sum_sell_&goods&
			remove_variable = trade_do_trade_t_&goods&
			remove_variable = trade_do_trade_tt_&goods&
			remove_variable = trade_do_trade_ttt_&goods&
		^
		
		remove_variable = trade_cost
		remove_variable = trade_do_trade_t
		remove_variable = trade_do_trade_tt
		remove_variable = trade_do_trade_ttt
		remove_variable = trade_do_trade_capital
	}
	
	every_ruler = {
		limit = {
			is_character = yes
			is_landed = yes
		}
		^^goods^
			set_variable = { name = trade_do_trade_t value = var:trade_sply_&goods& }
			change_variable = { name = trade_do_trade_t subtract = var:trade_out_&goods& }
			set_variable = { name = trade_do_trade_tt value = capital_county.var:trade_dmnd_&goods& }
			change_variable = { name = trade_do_trade_tt subtract = capital_county.var:trade_in_&goods& }
			
			if = {
				limit = {
					capital_county.var:trade_price_&goods& = {
						compare_value < prev.var:trade_price_&goods&
					}
				}
				set_variable = { name = trade_do_trade_ttt value = capital_county.var:trade_price_&goods& }
				change_variable = { name = trade_do_trade_ttt multiply = 10 }
				change_variable = { name = trade_do_trade_ttt divide = var:trade_price_&goods& }
				change_variable = { name = trade_do_trade_ttt multiply = var:trade_do_trade_ttt }
				change_variable = { name = trade_do_trade_tt multiply = var:trade_do_trade_ttt }
				change_variable = { name = trade_do_trade_tt divide = 100 }
			}
			if = {
				limit = {
					has_variable = task_manage_stockpile
				}
				change_variable = { name = trade_do_trade_tt multiply = var:task_manage_stockpile.var:task_time_in }
				change_variable = { name = trade_do_trade_tt divide = 100 }
			}
			
			if = {
				limit = {
					has_variable = trade_do_trade_t
					has_variable = trade_do_trade_tt
					
					var:trade_do_trade_t > 0
					var:trade_do_trade_tt > 0
				}
				if = {
					limit = {
						var:trade_do_trade_t = {
							compare_value > prev.var:trade_do_trade_tt
						}
					}
					set_variable = { name = trade_do_trade_t value = var:trade_do_trade_tt }
				}
				
				set_variable = { name = trade_do_trade_tt value = var:trade_price_&goods& }
				change_variable = { name = trade_do_trade_tt add = capital_county.var:trade_price_&goods& }
				change_variable = { name = trade_do_trade_tt divide = 2 }
				change_variable = { name = trade_do_trade_tt multiply = var:trade_do_trade_t }
				
				change_variable = { name = trade_out_&goods& add = var:trade_do_trade_t }
				change_variable = { name = trade_earn_&goods& add = var:trade_do_trade_tt }
				
				capital_county = {
					change_variable = { name = trade_in_&goods& add = prev.var:trade_do_trade_t }
					change_variable = { name = trade_pay_&goods& add = prev.var:trade_do_trade_tt }
				}
			}
			
			set_variable = { name = trade_do_trade_t value = var:trade_dmnd_&goods& }
			change_variable = { name = trade_do_trade_t subtract = var:trade_in_&goods& }
			set_variable = { name = trade_do_trade_tt value = capital_county.var:trade_sply_&goods& }
			change_variable = { name = trade_do_trade_tt subtract = capital_county.var:trade_out_&goods& }
			
			if = {
				limit = {
					capital_county.var:trade_price_&goods& = {
						compare_value > prev.var:trade_price_&goods&
					}
				}
				set_variable = { name = trade_do_trade_ttt value = var:trade_price_&goods& }
				change_variable = { name = trade_do_trade_ttt multiply = 10 }
				change_variable = { name = trade_do_trade_ttt divide = capital_county.var:trade_price_&goods& }
				change_variable = { name = trade_do_trade_ttt multiply = var:trade_do_trade_ttt }
				change_variable = { name = trade_do_trade_tt multiply = var:trade_do_trade_ttt }
				change_variable = { name = trade_do_trade_tt divide = 100 }
			}
			if = {
				limit = {
					has_variable = task_manage_stockpile
				}
				change_variable = { name = trade_do_trade_tt multiply = var:task_manage_stockpile.var:task_time_in }
				change_variable = { name = trade_do_trade_tt divide = 100 }
			}
			
			if = {
				limit = {
					has_variable = trade_do_trade_t
					has_variable = trade_do_trade_tt
					
					var:trade_do_trade_t > 0
					var:trade_do_trade_tt > 0
				}
				if = {
					limit = {
						var:trade_do_trade_t = {
							compare_value > prev.var:trade_do_trade_tt
						}
					}
					set_variable = { name = trade_do_trade_t value = var:trade_do_trade_tt }
				}
				
				set_variable = { name = trade_do_trade_tt value = var:trade_price_&goods& }
				change_variable = { name = trade_do_trade_tt add = capital_county.var:trade_price_&goods& }
				change_variable = { name = trade_do_trade_tt divide = 2 }
				change_variable = { name = trade_do_trade_tt multiply = var:trade_do_trade_t }
				
				change_variable = { name = trade_in_&goods& add = var:trade_do_trade_t }
				change_variable = { name = trade_pay_&goods& add = var:trade_do_trade_tt }
				
				capital_county = {
					change_variable = { name = trade_out_&goods& add = prev.var:trade_do_trade_t }
					change_variable = { name = trade_earn_&goods& add = prev.var:trade_do_trade_tt }
				}
			}
			
			remove_variable = trade_buy_&goods&
			remove_variable = trade_sell_&goods&
			remove_variable = trade_point_&goods&
			remove_variable = trade_sum_buy_&goods&
			remove_variable = trade_sum_sell_&goods&
			remove_variable = trade_do_trade_t_&goods&
			remove_variable = trade_do_trade_tt_&goods&
			remove_variable = trade_do_trade_ttt_&goods&
		^
		
		remove_variable = trade_cost
		remove_variable = trade_do_trade_t
		remove_variable = trade_do_trade_tt
		remove_variable = trade_do_trade_ttt
	}
	
	every_in_global_list = {
		variable = trade_merchants
		
		^^goods^
			remove_variable = trade_buy_&goods&
			remove_variable = trade_sell_&goods&
			remove_variable = trade_point_&goods&
			remove_variable = trade_sum_buy_&goods&
			remove_variable = trade_sum_sell_&goods&
			remove_variable = trade_do_trade_t_&goods&
			remove_variable = trade_do_trade_tt_&goods&
			remove_variable = trade_do_trade_ttt_&goods&
		^
		
		remove_global_variable = trade_do_trade_tt
		
		remove_variable = trade_cost
		remove_variable = trade_do_trade_t
		remove_variable = trade_do_trade_tt
		remove_variable = trade_do_trade_ttt
	}
	
	remove_global_variable = trade_do_trade_t
	remove_global_variable = trade_do_trade_tt
}

trade_do_trade_helper_0 = {
	save_temporary_scope_as = trade_do_trade_select
	
	every_county_province = {
		limit = {
			is_valid_prov = yes
		}
		every_in_list = {
			variable = prod_instances
			
			^^goods^
				if = { 
					limit = { 
						has_variable = prod_dmnd_&goods& 
					} 
					scope:trade_do_trade_select = { 
						change_variable = { name = trade_dmnd_&goods& add = prev.var:prod_dmnd_&goods& } 
					} 
				}
				if = { 
					limit = { 
						has_variable = prod_sply_old_&goods& 
					} 
					scope:trade_do_trade_select = { 
						change_variable = { name = trade_sply_&goods& add = prev.var:prod_sply_old_&goods& } 
					} 
				}
			^
		}
		
		if = {
			limit = {
				has_variable_list = build_slots
				
				variable_list_size = { name = build_slots value >= 1 }
			}
			every_in_list = {
				variable = build_slots
				
				^^goods^
					if = { 
						limit = { 
							has_variable = build_&goods& 
						} 
						scope:trade_do_trade_select = { 
							change_variable = { name = trade_dmnd_&goods& add = prev.var:build_&goods& } 
						} 
					}
				^
			}
		}
		
		^^goods^
			if = {
				limit = {
					has_variable = pop_calorie_&goods&
				}
				scope:trade_do_trade_select = {
					change_variable = { name = trade_dmnd_&goods& add = prev.var:pop_calorie_&goods& }
				}
			}
			if = {
				limit = {
					has_variable = pop_nutrient_&goods&
				}
				scope:trade_do_trade_select = {
					change_variable = { name = trade_dmnd_&goods& add = prev.var:pop_nutrient_&goods& }
				}
			}
			if = {
				limit = {
					has_variable = pop_comfort_&goods&
				}
				scope:trade_do_trade_select = {
					change_variable = { name = trade_dmnd_&goods& add = prev.var:pop_comfort_&goods& }
				}
			}
			if = {
				limit = {
					has_variable = pop_luxury_&goods&
				}
				scope:trade_do_trade_select = {
					change_variable = { name = trade_dmnd_&goods& add = prev.var:pop_luxury_&goods& }
				}
			}
			if = {
				limit = {
					has_variable = mil_supply_&goods&
				}
				scope:trade_do_trade_select = {
					change_variable = { name = trade_dmnd_&goods& add = prev.var:mil_supply_&goods& }
				}
			}
		^
	}
	
	^^goods^
		if = {
			limit = {
				has_variable = prod_tools_dmnd_&goods&
				
				var:prod_tools_dmnd_&goods& > 0
			}
			change_variable = { name = trade_dmnd_&goods& add = var:prod_tools_dmnd_&goods& }
		}
	^
}

trade_do_trade_helper_1 = {
	if = {
		limit = {
			has_variable = trade_sply_$good$
			
			var:trade_sply_$good$ > 0
		}
		change_variable = { name = trade_has_$good$ add = var:trade_sply_$good$ }
	}
	
	change_variable = { name = trade_sum_sply_$good$ multiply = 0.75 }
	change_variable = { name = trade_sum_sply_$good$ add = var:trade_sply_$good$ }
	
	if = {
		limit = {
			has_variable = trade_has_$good$
			
			var:trade_has_$good$ > 0
		}
		set_variable = { name = trade_sply_$good$ value = var:trade_has_$good$ }
		change_variable = { name = trade_sply_$good$ divide = 2 }
	}
	else = {
		set_variable = { name = trade_sply_$good$ value = 0 }
	}
	
	if = {
		limit = {
			has_variable = trade_sply_$good$
			has_variable = trade_dmnd_$good$
			
			var:trade_sply_$good$ > 0
			var:trade_dmnd_$good$ > 0
		}
		if = {
			limit = {
				var:trade_sply_$good$ = {
					compare_value >= prev.var:trade_dmnd_$good$
				}
			}
			set_variable = { name = trade_in_$good$ value = var:trade_dmnd_$good$ }
			set_variable = { name = trade_out_$good$ value = var:trade_dmnd_$good$ }
		}
		else = {
			set_variable = { name = trade_in_$good$ value = var:trade_sply_$good$ }
			set_variable = { name = trade_out_$good$ value = var:trade_sply_$good$ }
		}
		
		set_variable = { name = trade_earn_$good$ value = var:trade_out_$good$ }
		set_variable = { name = trade_pay_$good$ value = var:trade_in_$good$ }
		
		change_variable = { name = trade_earn_$good$ multiply = var:trade_price_$good$ }
		change_variable = { name = trade_pay_$good$ multiply = var:trade_price_$good$ }
	}
	else = {
		set_variable = { name = trade_in_$good$ value = 0 }
		set_variable = { name = trade_out_$good$ value = 0 }
		set_variable = { name = trade_earn_$good$ value = 0 }
		set_variable = { name = trade_pay_$good$ value = 0 }
	}
}

trade_do_trade_helper_2 = {
	if = {
		limit = {
			OR = {
				AND = {
					var:trade_$type1$_$good$ = 0
					
					NOT = {
						var:trade_sum_$type0$_$good$ = 0
					}
				}
				
				var:trade_$type1$_$good$ = {
					compare_value < prev.var:trade_sum_$type0$_$good$
				}
			}
		}
		set_variable = { name = trade_do_trade_t value = 0.001 }
		
		every_in_global_list = {
			limit = {
				var:trade_$type0$_$good$ > 0
				var:trade_point_$good$ > 0
			}
			variable = trade_do_trade_list
			
			add_to_global_variable_list = { name = trade_do_trade_t target = this }
			
			if = {
				limit = {
					var:trade_point_$good$ = {
						compare_value > global_var:trade_do_trade_select.var:trade_do_trade_t
					}
				}
				prev = {
					set_variable = { name = trade_do_trade_t value = prev.var:trade_point_$good$ }
				}
			}
		}
		
		every_in_global_list = {
			variable = trade_do_trade_t
			
			set_variable = { name = trade_do_trade_t value = var:trade_point_$good$ }
			change_variable = { name = trade_do_trade_t multiply = 100 }
			change_variable = { name = trade_do_trade_t divide = prev.var:trade_do_trade_t }
			
			set_variable = { name = trade_do_trade_tt value = 0 }
		}
		
		set_variable = { name = trade_do_trade_t value = 0 }
		
		every_in_global_list = {
			variable = trade_do_trade_t
			
			prev = {
				change_variable = { name = trade_do_trade_t add = prev.var:trade_do_trade_t }
			}
		}
		
		set_variable = { name = trade_do_trade_tt value = var:trade_$type1$_$good$ }
		
		while = {
			limit = {
				has_variable = trade_do_trade_t
				has_variable = trade_do_trade_tt
				
				var:trade_do_trade_t > 0
				var:trade_do_trade_tt > 0
			}
			set_variable = { name = trade_do_trade_ttt value = 100 }
			change_variable = { name = trade_do_trade_ttt multiply = var:trade_do_trade_tt }
			change_variable = { name = trade_do_trade_ttt divide = var:trade_do_trade_t }
			
			every_in_global_list = {
				variable = trade_do_trade_t
				
				set_variable = { name = trade_do_trade_ttt value = var:trade_do_trade_t }
				change_variable = { name = trade_do_trade_ttt multiply = prev.var:trade_do_trade_ttt }
				change_variable = { name = trade_do_trade_ttt divide = 100 }
				change_variable = { name = trade_do_trade_tt add = var:trade_do_trade_ttt }
			}
			
			set_variable = { name = trade_do_trade_ttt value = 0 }
			
			every_in_global_list = {
				variable = trade_do_trade_t
				
				if = {
					limit = {
						has_variable = trade_do_trade_tt
						
						var:trade_do_trade_tt = {
							compare_value >= prev.var:trade_$type0$_$good$
						}
					}
					change_variable = { name = trade_do_trade_ttt subtract = var:trade_do_trade_tt }
					change_variable = { name = trade_do_trade_ttt add = var:trade_$type0$_$good$ }
					
					set_variable = { name = trade_do_trade_tt value = var:trade_$type0$_$good$ }
					
					prev = {
						change_variable = { name = trade_do_trade_t subtract = prev.var:trade_do_trade_t }
					}
					
					remove_list_global_variable = { name = trade_do_trade_t target = this }
					
					set_variable = { name = trade_do_trade_t value = 0 }
				}
				
				prev = {
					change_variable = { name = trade_do_trade_ttt add = prev.var:trade_do_trade_ttt }
				}
			}
			
			if = {
				limit = {
					OR = {
						NOT = {
							has_variable = trade_do_trade_ttt
						}
						
						var:trade_do_trade_ttt < 0.2
					}
				}
				set_variable = { name = trade_do_trade_tt value = 0 }
			}
			else = {
				change_variable = { name = trade_do_trade_tt subtract = var:trade_do_trade_ttt }
			}
		}
		
		set_variable = { name = trade_sum_$type0$_$good$ value = 0 }
		
		every_in_global_list = {
			limit = {
				var:trade_$type0$_$good$ > 0
				var:trade_point_$good$ > 0
			}
			variable = trade_do_trade_list
			
			if = {
				limit = {
					OR = {
						NOT = {
							has_variable = trade_do_trade_tt
						}
						
						var:trade_do_trade_tt = 0
					}
				}
				set_variable = { name = trade_$type0$_$good$ value = 0 }
				
				remove_variable = trade_point_$good$
			}
			else = {
				set_variable = { name = trade_$type0$_$good$ value = var:trade_do_trade_tt }
				
				prev = {
					change_variable = { name = trade_sum_$type0$_$good$ add = prev.var:trade_$type0$_$good$ }
				}
			}
		}
		
		clear_global_variable_list = trade_do_trade_t
	}
}

trade_do_trade_helper_4 = {
	set_variable = { name = trade_do_trade_t value = var:trade_price_$good$ }
	change_variable = { name = trade_do_trade_t add = prev.var:trade_price_$good$ }
	change_variable = { name = trade_do_trade_t divide = 2 }
	
	if = {
		limit = {
			has_variable = trade_buy_$good$ 
			
			var:trade_buy_$good$ > 0
		}
		change_variable = { name = trade_in_$good$ add = var:trade_buy_$good$ }
		
		prev = {
			change_variable = { name = trade_out_$good$ add = prev.var:trade_buy_$good$ }
		}
		
		change_variable = { name = trade_buy_$good$ multiply = var:trade_do_trade_t }
		change_variable = { name = trade_pay_$good$ add = var:trade_buy_$good$ }
		
		prev = {
			change_variable = { name = trade_earn_$good$ add = prev.var:trade_buy_$good$ }
		}
	}
	if = {
		limit = {
			has_variable = trade_sell_$good$
			
			var:trade_sell_$good$ > 0
		}
		change_variable = { name = trade_out_$good$ add = var:trade_sell_$good$ }
		
		prev = {
			change_variable = { name = trade_in_$good$ add = prev.var:trade_sell_$good$ }
		}
		
		change_variable = { name = trade_sell_$good$ multiply = var:trade_do_trade_t }
		change_variable = { name = trade_earn_$good$ add = var:trade_sell_$good$ }
		
		prev = {
			change_variable = { name = trade_pay_$good$ add = prev.var:trade_sell_$good$ }
		}
	}
}

trade_resolve_trade = {
	every_ruler = {
		limit = {
			is_character = yes
			is_landed = yes
		}
		set_variable = { name = trade_earn value = 0 }
		set_variable = { name = trade_pay value = 0 }
		
		^^goods^
			change_variable = { name = trade_has_&goods& add = var:trade_in_&goods& }
			change_variable = { name = trade_has_&goods& subtract = var:trade_out_&goods& }
			change_variable = { name = trade_earn add = var:trade_earn_&goods& }
			change_variable = { name = trade_pay add = var:trade_pay_&goods& }
		^
	}
	every_province = {
		limit = {
			is_valid_prov = yes
		}
		set_variable = { name = pop_pay_calorie value = 0 }
		set_variable = { name = pop_pay_nutrient value = 0 }
		set_variable = { name = pop_pay_comfort value = 0 }
		set_variable = { name = pop_pay_luxury value = 0 }
		set_variable = { name = pop_pay_supply value = 0 }
		
		^^goods^set_variable = { name = prod_earn_&goods& value = 0 }^
	}
	every_in_global_list = {
		variable = prod_instances
		
		set_variable = { name = prod_tools_pay value = 0 }
		
		^^goods^
			set_variable = { name = prod_earn_&goods& value = 0 }
			set_variable = { name = prod_pay_&goods& value = 0 }
		^
	}
	
	if = {
		limit = {
			has_global_variable_list = build_slots_active
				
			global_variable_list_size = { name = build_slots_active value >= 1}
		}
		every_in_global_list = {
			variable = build_slots_active
			
			^^goods^
				if = {
					limit = {
						has_variable = build_&goods&
						
						var:build_&goods& > 0
					}
					set_variable = { name = build_in_&goods& value = 0 }
					set_variable = { name = build_pay_&goods& value = 0 }
				}
			^
		}
	}
	
	every_county = {
		limit = {
			is_valid_prov = yes
		}
		set_variable = { name = prod_pay value = 0 }
		
		^^goods^trade_resolve_trade_helper_0 = { good = &goods& }^
		^^goods^trade_resolve_trade_helper_1 = { good = &goods& }^
		
		set_variable = { name = trade_resolve_trade_t value = 0 }
		
		every_in_list = {
			variable = prod_instances
			
			prev = {
				change_variable = { name = trade_resolve_trade_t add = prev.var:prod_size }
			}
		}
		every_in_list = {
			variable = prod_instances
			
			set_variable = { name = prod_tools_pay value = var:prod_size }
			change_variable = { name = prod_tools_pay multiply = 100 }
			change_variable = { name = prod_tools_pay divide = prev.var:trade_resolve_trade_t }
			change_variable = { name = prod_tools_pay multiply = prev.var:prod_pay }
			change_variable = { name = prod_tools_pay divide = 100 }
		}
		
		remove_variable = trade_resolve_trade_t
		remove_variable = trade_resolve_trade_tt
		remove_variable = trade_resolve_trade_ttt
	}
	
	every_in_global_list = {
		variable = prod_instances
		
		set_variable = { name = prod_pay_old value = var:prod_pay }
		set_variable = { name = prod_earn_old value = var:prod_earn }
		
		set_variable = { name = prod_pay value = 0 } 
		set_variable = { name = prod_earn value = 0 } 
		
		^^goods^
			if = {
				limit = {
					has_variable = prod_pay_&goods&
					
					var:prod_pay_&goods& > 0
				}
				change_variable = { name = prod_pay add = var:prod_pay_&goods& }
			}
			else = {
				remove_variable = prod_pay_&goods&
			}
			if = {
				limit = {
					has_variable = prod_earn_&goods&
					
					var:prod_earn_&goods& > 0
				}
				change_variable = { name = prod_earn add = var:prod_earn_&goods& }
			}
			else = {
				remove_variable = prod_earn_&goods&
			}
		^
		
		if = {
			limit = {
				has_variable = prod_tools_pay
				
				var:prod_tools_pay > 0
			}
			change_variable = { name = prod_pay add = var:prod_tools_pay }
		}
		
		remove_variable = trade_resolve_trade_t
	}
	
	if = {
		limit = {
			has_global_variable_list = build_slots_active
				
			global_variable_list_size = { name = build_slots_active value >= 1}
		}
		every_in_global_list = {
			variable = build_slots_active
			
			set_variable = { name = build_pay value = 0 }  
			
			^^goods^
				if = {
					limit = {
						has_variable = build_pay_&goods&
						
						var:build_pay_&goods& > 0
					}
					change_variable = { name = build_pay add = var:build_pay_&goods& }
				}
				else = {
					remove_variable = build_pay_&goods&
				}
			^
		}
	}
	
	every_province = {
		limit = {
			is_valid_prov = yes
		}
		set_variable = { name = pop_pay_serf value = 0 }
		set_variable = { name = pop_pay_free value = 0 }
		
		set_variable = { name = trade_resolve_trade_t value = var:pop_pay_calorie }
		change_variable = { name = trade_resolve_trade_t multiply = var:pop_calorie_serf_share }
		change_variable = { name = pop_pay_free add = var:pop_pay_calorie }
		change_variable = { name = pop_pay_free subtract = var:trade_resolve_trade_t }
		change_variable = { name = pop_pay_serf add = var:trade_resolve_trade_t }
		
		set_variable = { name = trade_resolve_trade_t value = var:pop_pay_nutrient }
		change_variable = { name = trade_resolve_trade_t multiply = var:pop_nutrient_serf_share }
		change_variable = { name = pop_pay_free add = var:pop_pay_nutrient }
		change_variable = { name = pop_pay_free subtract = var:trade_resolve_trade_t }
		change_variable = { name = pop_pay_serf add = var:trade_resolve_trade_t }
		
		set_variable = { name = trade_resolve_trade_t value = var:pop_pay_comfort }
		change_variable = { name = trade_resolve_trade_t multiply = var:pop_comfort_serf_share }
		change_variable = { name = pop_pay_free add = var:pop_pay_comfort }
		change_variable = { name = pop_pay_free subtract = var:trade_resolve_trade_t }
		change_variable = { name = pop_pay_serf add = var:trade_resolve_trade_t }
		
		set_variable = { name = trade_resolve_trade_t value = var:pop_pay_luxury }
		change_variable = { name = trade_resolve_trade_t multiply = var:pop_luxury_serf_share }
		change_variable = { name = pop_pay_free add = var:pop_pay_luxury }
		change_variable = { name = pop_pay_free subtract = var:trade_resolve_trade_t }
		change_variable = { name = pop_pay_serf add = var:trade_resolve_trade_t }
		
		change_variable = { name = pop_pay_free add = var:pop_pay_supply }
		
		if = {
			limit = {
				has_variable_list = build_slots
				
				variable_list_size = { name = build_slots value >= 1 }
			}
			every_in_list = {
				limit = {
					has_variable = build_pay
					
					var:build_pay > 0
				}
				variable = build_slots
				
				if = {
					limit = {
						var:build_owner = 1
					}
					prev = {
						change_variable = { name = pop_pay_serf add = prev.var:build_pay }
					}
				}
				else_if = {
					limit = {
						var:build_owner = 2
					}
					prev = {
						change_variable = { name = pop_pay_free add = prev.var:build_pay }
					}
				}
			}
		}
		
		set_variable = { name = trade_resolve_trade_t value = 0 }
		
		^^goods^
			if = {
				limit = {
					has_variable = prod_earn_&goods&
					
					var:prod_earn_&goods& > 0
				}
				change_variable = { name = trade_resolve_trade_t add = var:prod_earn_&goods& }
			}
			else = {
				remove_variable = prod_earn_&goods&
			}
		^
		
		every_in_list = {
			variable = prod_instances
			
			prev = {
				change_variable = { name = trade_resolve_trade_t subtract = prev.var:prod_pay }
			}
		}
		
		change_variable = { name = trade_resolve_trade_t divide = 2 }
		
		set_variable = { name = pop_earn_free value = var:pop_freedom }
		change_variable = { name = pop_earn_free multiply = var:trade_resolve_trade_t }
		
		set_variable = { name = pop_earn_serf value = var:trade_resolve_trade_t }
		change_variable = { name = pop_earn_serf subtract = var:pop_earn_free }
		
		change_variable = { name = pop_earn_free add = var:trade_resolve_trade_t }
		
		remove_variable = trade_resolve_trade_t
		remove_variable = trade_resolve_trade_tt
	}
	
	every_in_global_list = {
		variable = trade_merchants
		
		set_variable = { name = trade_earn value = 0 }
		set_variable = { name = trade_pay value = 0 }
		
		^^goods^
			change_variable = { name = trade_earn add = var:trade_earn_&goods& }
			change_variable = { name = trade_pay add = var:trade_pay_&goods& }
		^
		
		change_variable = { name = trade_wealth add = var:trade_earn }
		change_variable = { name = trade_wealth subtract = var:trade_pay }
		
		if = {
			limit = {
				OR = {
					NOT = {
						has_variable = trade_wealth
					}
					
					var:trade_wealth <= 0
				}
			}
			set_variable = { name = trade_wealth value = 0 }
		}
		
		set_variable = { name = trade_retire_pay value = var:trade_retire }
		change_variable = { name = trade_retire_pay multiply = var:trade_wealth }
		change_variable = { name = trade_retire_pay divide = 100 }
		change_variable = { name = trade_wealth subtract = var:trade_retire_pay }
		change_variable = { name = trade_pay add = var:trade_retire_pay }
		var:trade_location = { change_variable = { name = pop_earn_free add = prev.var:trade_retire_pay } }
		
		remove_variable = trade_resolve_trade_t
		remove_variable = trade_resolve_trade_tt
	}
}

trade_resolve_trade_helper_0 = {
	change_variable = { name = trade_has_$good$ subtract = var:trade_out_$good$ }
	change_variable = { name = trade_has_$good$ multiply = 0.95 }
	
	set_variable = { name = trade_resolve_trade_t value = 0 }
	
	every_county_province = {
		limit = {
			is_valid_prov = yes
		}
		set_variable = { name = prod_has_$good$ value = 0 }
		
		every_in_list = {
			limit = {
				has_variable = prod_sply_old_$good$
			}
			variable = prod_instances
			
			change_variable = { name = prod_has_$good$ add = var:prod_sply_old_$good$ }
			
			prev = {
				change_variable = { name = prod_has_$good$ add = prev.var:prod_has_$good$ }
			}
		}
		
		prev = {
			change_variable = { name = trade_resolve_trade_t add = prev.var:prod_has_$good$ }
		}
	}
	
	if = {
		limit = {
			has_variable = trade_resolve_trade_t
			
			var:trade_resolve_trade_t > 0
		}
		every_county_province = {
			limit = {
				has_variable = prod_has_$good$
					
				var:prod_has_$good$ > 0
			}
			every_in_list = {
				limit = {
					has_variable = prod_has_$good$
					
					var:prod_has_$good$ > 0
				}
				variable = prod_instances
				
				change_variable = { name = prod_has_$good$ multiply = 100 }
				change_variable = { name = prod_has_$good$ divide = prev.var:prod_has_$good$ }
			}
			
			change_variable = { name = prod_has_$good$ multiply = 100 }
			change_variable = { name = prod_has_$good$ divide = prev.var:trade_resolve_trade_t }
			change_variable = { name = prod_has_$good$ multiply = prev.var:trade_has_$good$ }
			change_variable = { name = prod_has_$good$ divide = 100 }
			
			every_in_list = {
				limit = {
					has_variable = prod_has_$good$
					
					var:prod_has_$good$ > 0
				}
				variable = prod_instances
				
				change_variable = { name = prod_has_$good$ multiply = prev.var:prod_has_$good$ }
				change_variable = { name = prod_has_$good$ divide = 100 }
			}
		}
	}
	
	if = {
		limit = {
			has_variable = trade_earn_$good$
			
			var:trade_earn_$good$ > 0
		}
		every_county_province = {
			limit = {
				has_variable = prod_has_$good$
					
				var:prod_has_$good$ > 0
			}
			set_variable = { name = prod_earn_$good$ value = var:prod_has_$good$ }
			change_variable = { name = prod_earn_$good$ multiply = 100 }
			change_variable = { name = prod_earn_$good$ divide = prev.var:trade_has_$good$ }
			change_variable = { name = prod_earn_$good$ multiply = prev.var:trade_earn_$good$ }
			change_variable = { name = prod_earn_$good$ divide = 100 }
			
			every_in_list = {
				limit = {
					has_variable = prod_has_$good$
					
					var:prod_has_$good$ > 0
				}
				variable = prod_instances
				
				set_variable = { name = prod_earn_$good$ value = var:prod_has_$good$ }
				change_variable = { name = prod_earn_$good$ multiply = 100 }
				change_variable = { name = prod_earn_$good$ divide = prev.var:prod_has_$good$ }
				change_variable = { name = prod_earn_$good$ multiply = prev.var:prod_earn_$good$ }
				change_variable = { name = prod_earn_$good$ divide = 100 }
			}
		}
	}
}

trade_resolve_trade_helper_1 = {
	if = {
		limit = {
			has_variable = trade_dmnd_$good$
			
			var:trade_dmnd_$good$ > 0
		}
		set_variable = { name = trade_resolve_trade_t value = var:trade_pay_$good$ }
		change_variable = { name = trade_resolve_trade_t divide = var:trade_dmnd_$good$ }
		
		set_variable = { name = trade_resolve_trade_tt value = var:trade_in_$good$ }
		change_variable = { name = trade_resolve_trade_tt multiply = 100 }
		change_variable = { name = trade_resolve_trade_tt divide = var:trade_dmnd_$good$ }
		
		if = {
			limit = {
				has_variable = prod_tools_dmnd_$good$
			}
			set_variable = { name = prod_tools_in_$good$ value = var:prod_tools_dmnd_$good$ }
			change_variable = { name = prod_tools_in_$good$ multiply = var:trade_resolve_trade_tt }
			change_variable = { name = prod_tools_in_$good$ divide = 100 }
			
			set_variable = { name = trade_resolve_trade_ttt value = var:prod_tools_dmnd_$good$ }
			change_variable = { name = trade_resolve_trade_ttt multiply = var:trade_resolve_trade_t }
			change_variable = { name = prod_pay add = var:trade_resolve_trade_ttt }
		}
		
		every_county_province = {
			limit = {
				is_valid_prov = yes
			}
			trade_resolve_trade_helper_1_helper = { type = calorie good = $good$ }
			trade_resolve_trade_helper_1_helper = { type = nutrient good = $good$ }
			trade_resolve_trade_helper_1_helper = { type = comfort good = $good$ }
			trade_resolve_trade_helper_1_helper = { type = luxury good = $good$ }
		
			if = {
				limit = {
					has_variable = mil_supply_$good$
				}
				set_variable = { name = mil_supply_in_$good$ value = var:mil_supply_$good$ }
				change_variable = { name = mil_supply_in_$good$ multiply = prev.var:trade_resolve_trade_tt }
				change_variable = { name = mil_supply_in_$good$ divide = 100 }
				
				set_variable = { name = trade_resolve_trade_t value = var:mil_supply_$good$ }
				change_variable = { name = trade_resolve_trade_t multiply = prev.var:trade_resolve_trade_t }
				change_variable = { name = pop_pay_supply add = var:trade_resolve_trade_t }
			}
			
			set_variable = { name = trade_resolve_trade_t value = prev.var:trade_resolve_trade_t }
			set_variable = { name = trade_resolve_trade_tt value = prev.var:trade_resolve_trade_tt }
			
			every_in_list = {
				variable = prod_instances
				
				if = {
					limit = {
						has_variable = prod_dmnd_$good$
					}
					set_variable = { name = prod_in_$good$ value = var:prod_dmnd_$good$ }
					change_variable = { name = prod_in_$good$ multiply = prev.var:trade_resolve_trade_tt }
					change_variable = { name = prod_in_$good$ divide = 100 }
					
					set_variable = { name = prod_pay_$good$ value = var:prod_dmnd_$good$ }
					change_variable = { name = prod_pay_$good$ multiply = prev.var:trade_resolve_trade_t }
				}
			}
			
			if = {
				limit = {
					has_variable_list = build_slots
					
					variable_list_size = { name = build_slots value >= 1 }
				}
				every_in_list = {
					limit = {
						has_variable = build_$good$
						
						var:build_$good$ > 0
					}
					variable = build_slots
					
					set_variable = { name = build_in_$good$ value = var:build_$good$ }
					change_variable = { name = build_in_$good$ multiply = prev.var:trade_resolve_trade_tt }
					change_variable = { name = build_in_$good$ divide = 100 }
					
					set_variable = { name = build_pay_$good$ value = var:build_$good$ }
					change_variable = { name = build_pay_$good$ multiply = prev.var:trade_resolve_trade_t }
				}
			}
		}
	}
	else = {
		set_variable = { name = prod_tools_in_$good$ value = 0 }
		
		every_county_province = {
			limit = {
				is_valid_prov = yes
			}
			set_variable = { name = pop_calorie_actual_$good$ value = 0 }
			set_variable = { name = pop_nutrient_actual_$good$ value = 0 }
			set_variable = { name = pop_comfort_actual_$good$ value = 0 }
			set_variable = { name = pop_luxury_actual_$good$ value = 0 }
			
			every_in_list = {
				limit = {
					has_variable = prod_dmnd_$good$
				}
				variable = prod_instances
				
				set_variable = { name = prod_in_$good$ value = 0 }
				set_variable = { name = prod_pay_$good$ value = 0 }
			}
			
			if = {
				limit = {
					has_variable_list = build_slots
					
					variable_list_size = { name = build_slots value >= 1 }
				}
				every_in_list = {
					limit = {
						has_variable = build_$good$
					}
					variable = build_slots
					
					set_variable = { name = build_in_$good$ value = 0 }
					set_variable = { name = build_pay_$good$ value = 0 }
				}
			}
		}
	}
}

trade_resolve_trade_helper_1_helper = {
	if = {
		limit = {
			has_variable = pop_$type$_$good$
			
			var:pop_$type$_$good$ > 0
		}
		set_variable = { name = pop_$type$_actual_$good$ value = var:pop_$type$_$good$ }
		change_variable = { name = pop_$type$_actual_$good$ multiply = prev.var:trade_resolve_trade_tt }
		change_variable = { name = pop_$type$_actual_$good$ divide = 100 }
		
		set_variable = { name = trade_resolve_trade_t value = var:pop_$type$_$good$ }
		change_variable = { name = trade_resolve_trade_t multiply = prev.var:trade_resolve_trade_t }
		change_variable = { name = pop_pay_$type$ add = var:trade_resolve_trade_t }
	}
	else = {
		remove_variable = pop_$type$_actual_$good$
	}
}

trade_update_price = {
	every_ruler = {
		limit = {
			is_character = yes
			is_landed = yes
		}
		^^goods^
			set_variable = { name = trade_update_price_ttt value = var:trade_price_&goods& }
			
			set_variable = { name = trade_update_price_tt value = var:trade_sply_&goods& }
			change_variable = { name = trade_update_price_tt subtract = var:trade_dmnd_&goods& }
			
			if = {
				limit = {
					has_variable = trade_update_price_tt
					
					var:trade_update_price_tt != 0
				}
				set_variable = { name = trade_update_price_t value = var:trade_out_&goods& }
				change_variable = { name = trade_update_price_t subtract = var:trade_in_&goods& }
				change_variable = { name = trade_update_price_t multiply = 100 }
				change_variable = { name = trade_update_price_t divide = var:trade_update_price_tt }
				change_variable = { name = trade_update_price_t subtract = 80 }
				
				if = {
					limit = {
						has_variable = trade_update_price_t
						
						var:trade_update_price_t != 0
					}
					if = {
						limit = {
							var:trade_update_price_tt > 0
						}
						if = {
							limit = {
								var:trade_update_price_t > 0
							}
							change_variable = { name = trade_update_price_t divide = 10 }
							change_variable = { name = trade_update_price_t add = 100 }
							change_variable = { name = trade_price_&goods& multiply = var:trade_update_price_t }
							change_variable = { name = trade_price_&goods& divide = 100 }
						}
						else = {
							limit = {
								var:trade_update_price_t < 0
							}
							change_variable = { name = trade_update_price_t divide = -20 }
							change_variable = { name = trade_update_price_t add = 100 }
							change_variable = { name = trade_price_&goods& multiply = 100 }
							change_variable = { name = trade_price_&goods& divide = var:trade_update_price_t }
						}
					}
					else = {
						if = {
							limit = {
								var:trade_update_price_t > 0
							}
							change_variable = { name = trade_update_price_t divide = 10 }
							change_variable = { name = trade_update_price_t add = 100 }
							change_variable = { name = trade_price_&goods& multiply = 100 }
							change_variable = { name = trade_price_&goods& divide = var:trade_update_price_t }
						}
						else = {
							limit = {
								var:trade_update_price_t < 0
							}
							change_variable = { name = trade_update_price_t divide = -20 }
							change_variable = { name = trade_update_price_t add = 100 }
							change_variable = { name = trade_price_&goods& multiply = var:trade_update_price_t }
							change_variable = { name = trade_price_&goods& divide = 100 }
						}
					}
				}
			}
			
			if = {
				limit = {
					var:trade_price_&goods& > 50
				}
				set_variable = { name = trade_price_&goods& value = 50 }
			}
			else_if = {
				limit = {
					var:trade_price_&goods& < 0.5
				}
				set_variable = { name = trade_price_&goods& value = 0.5 }
			}
			
			if = {
				limit = {
					NOT = {
						has_variable = trade_price_trend_&goods&
					}
				}
				set_variable = { name = trade_price_trend_&goods& value = 0 }
			}
			
			change_variable = { name = trade_price_trend_&goods& multiply = 0.9 }
			
			if = {
				limit = {
					var:trade_update_price_ttt = {
						compare_value >= prev.var:trade_price_&goods&
					}
				}
				set_variable = { name = trade_update_price_t value = var:trade_update_price_ttt }
				change_variable = { name = trade_update_price_t divide = var:trade_price_&goods& }
				change_variable = { name = trade_update_price_t subtract = 1 }
				change_variable = { name = trade_price_trend_&goods& subtract = var:trade_update_price_t }
			}
			else = {
				set_variable = { name = trade_update_price_t value = var:trade_price_&goods& }
				change_variable = { name = trade_update_price_t divide = var:trade_update_price_ttt }
				change_variable = { name = trade_update_price_t subtract = 1 }
				change_variable = { name = trade_price_trend_&goods& add = var:trade_update_price_t }
			}
		^
		
		remove_variable = trade_update_price_t
		remove_variable = trade_update_price_tt
		remove_variable = trade_update_price_ttt
	}
	every_county = {
		limit = {
			is_valid_prov = yes
		}
		^^goods^
			set_variable = { name = trade_update_price_ttt value = var:trade_price_&goods& }
			
			set_variable = { name = trade_update_price_tt value = var:trade_sply_&goods& }
			change_variable = { name = trade_update_price_tt subtract = var:trade_dmnd_&goods& }
			
			if = {
				limit = {
					has_variable = trade_update_price_tt
					
					var:trade_update_price_tt != 0
				}
				set_variable = { name = trade_update_price_t value = var:trade_out_&goods& }
				change_variable = { name = trade_update_price_t subtract = var:trade_in_&goods& }
				change_variable = { name = trade_update_price_t multiply = 100 }
				change_variable = { name = trade_update_price_t divide = var:trade_update_price_tt }
				change_variable = { name = trade_update_price_t subtract = 80 }
				
				if = {
					limit = {
						has_variable = trade_update_price_t
						
						var:trade_update_price_t != 0
					}
					if = {
						limit = {
							var:trade_update_price_tt > 0
						}
						if = {
							limit = {
								var:trade_update_price_t > 0
							}
							change_variable = { name = trade_update_price_t divide = 10 }
							change_variable = { name = trade_update_price_t add = 100 }
							change_variable = { name = trade_price_&goods& multiply = var:trade_update_price_t }
							change_variable = { name = trade_price_&goods& divide = 100 }
						}
						else = {
							limit = {
								var:trade_update_price_t < 0
							}
							change_variable = { name = trade_update_price_t divide = -20 }
							change_variable = { name = trade_update_price_t add = 100 }
							change_variable = { name = trade_price_&goods& multiply = 100 }
							change_variable = { name = trade_price_&goods& divide = var:trade_update_price_t }
						}
					}
					else = {
						if = {
							limit = {
								var:trade_update_price_t > 0
							}
							change_variable = { name = trade_update_price_t divide = 10 }
							change_variable = { name = trade_update_price_t add = 100 }
							change_variable = { name = trade_price_&goods& multiply = 100 }
							change_variable = { name = trade_price_&goods& divide = var:trade_update_price_t }
						}
						else = {
							limit = {
								var:trade_update_price_t < 0
							}
							change_variable = { name = trade_update_price_t divide = -20 }
							change_variable = { name = trade_update_price_t add = 100 }
							change_variable = { name = trade_price_&goods& multiply = var:trade_update_price_t }
							change_variable = { name = trade_price_&goods& divide = 100 }
						}
					}
				}
			}
			
			if = {
				limit = {
					var:trade_price_&goods& > 50
				}
				set_variable = { name = trade_price_&goods& value = 50 }
			}
			else_if = {
				limit = {
					var:trade_price_&goods& < 0.5
				}
				set_variable = { name = trade_price_&goods& value = 0.5 }
			}
			
			if = {
				limit = {
					NOT = {
						has_variable = trade_price_trend_&goods&
					}
				}
				set_variable = { name = trade_price_trend_&goods& value = 0 }
			}
			
			change_variable = { name = trade_price_trend_&goods& multiply = 0.8 }
			
			if = {
				limit = {
					var:trade_update_price_ttt = {
						compare_value >= prev.var:trade_price_&goods&
					}
				}
				set_variable = { name = trade_update_price_t value = var:trade_update_price_ttt }
				change_variable = { name = trade_update_price_t divide = var:trade_price_&goods& }
				change_variable = { name = trade_update_price_t subtract = 1 }
				change_variable = { name = trade_price_trend_&goods& subtract = var:trade_update_price_t }
			}
			else = {
				set_variable = { name = trade_update_price_t value = var:trade_price_&goods& }
				change_variable = { name = trade_update_price_t divide = var:trade_update_price_ttt }
				change_variable = { name = trade_update_price_t subtract = 1 }
				change_variable = { name = trade_price_trend_&goods& add = var:trade_update_price_t }
			}
		^
		
		remove_variable = trade_update_price_t
		remove_variable = trade_update_price_tt
		remove_variable = trade_update_price_ttt
	}
	
	every_in_global_list = {
		variable = trade_merchants
		
		^^goods^
			set_variable = { name = trade_update_price_ttt value = var:trade_price_&goods& }
			
			trade_update_price_helper_1 = { good = &goods& }
			
			if = {
				limit = {
					var:trade_price_&goods& > 50
				}
				set_variable = { name = trade_price_&goods& value = 50 }
			}
			else_if = {
				limit = {
					var:trade_price_&goods& < 0.5
				}
				set_variable = { name = trade_price_&goods& value = 0.5 }
			}
			
			if = {
				limit = {
					NOT = {
						has_variable = trade_price_trend_&goods&
					}
				}
				set_variable = { name = trade_price_trend_&goods& value = 0 }
			}
			
			change_variable = { name = trade_price_trend_&goods& multiply = 0.8 }
			
			if = {
				limit = {
					var:trade_update_price_ttt = {
						compare_value >= prev.var:trade_price_&goods&
					}
				}
				set_variable = { name = trade_update_price_t value = var:trade_update_price_ttt }
				change_variable = { name = trade_update_price_t divide = var:trade_price_&goods& }
				change_variable = { name = trade_update_price_t subtract = 1 }
				change_variable = { name = trade_price_trend_&goods& subtract = var:trade_update_price_t }
			}
			else = {
				set_variable = { name = trade_update_price_t value = var:trade_price_&goods& }
				change_variable = { name = trade_update_price_t divide = var:trade_update_price_ttt }
				change_variable = { name = trade_update_price_t subtract = 1 }
				change_variable = { name = trade_price_trend_&goods& add = var:trade_update_price_t }
			}
		^
		
		remove_variable = trade_update_price_t
		remove_variable = trade_update_price_tt
		remove_variable = trade_update_price_ttt
	}
}

trade_update_price_helper_1 = {
	if = {
		limit = {
			has_variable = trade_want_$good$
			
			var:trade_want_$good$ > 0
		}
		set_variable = { name = trade_update_price_t value = var:trade_has_$good$ }
		change_variable = { name = trade_update_price_t multiply = 2 }
		change_variable = { name = trade_update_price_t subtract = var:trade_want_$good$ }
		change_variable = { name = trade_update_price_t divide = var:trade_want_$good$ }
		change_variable = { name = trade_update_price_t divide = 25 }
		
		if = {
			limit = {
				has_variable = trade_update_price_t
				
				var:trade_update_price_t != 0
			}
			if = {
				limit = {
					var:trade_update_price_t > 0
				}
				change_variable = { name = trade_update_price_t add = 1 }
				change_variable = { name = trade_price_$good$ divide = var:trade_update_price_t }
			}
			else = {
				change_variable = { name = trade_update_price_t multiply = -1 }
				change_variable = { name = trade_update_price_t add = 1 }
				change_variable = { name = trade_price_$good$ multiply = var:trade_update_price_t }
			}
		}
	}
}

trade_update_merchant = {
	every_in_global_list = {
		variable = trade_merchants
		
		^^goods^trade_update_merchant_helper = { good = &goods& }^
	}
}

trade_update_merchant_helper = {
	change_variable = { name = trade_want_$good$ multiply = 0.834 }
	change_variable = { name = trade_want_$good$ add = var:trade_out_$good$ }
	change_variable = { name = trade_want_$good$ add = 0.166 }
	
	change_variable = { name = trade_has_$good$ add = var:trade_in_$good$ }
	change_variable = { name = trade_has_$good$ subtract = var:trade_out_$good$ }
	
	if = {
		limit = {
			has_variable = trade_has_$good$
			
			var:trade_has_$good$ > 0
			
			var:trade_has_$good$ = {
				compare_value > prev.var:trade_want_$good$
			}
		}
		set_variable = { name = trade_want_$good$ value = var:trade_has_$good$ }
	}
}