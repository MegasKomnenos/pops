migration_main = {
	every_province = {
		limit = {
			is_valid_prov = yes
		}
		set_variable = { name = migration_main_t value = var:pop_nutrient }
		change_variable = { name = migration_main_t add = 1 }
		change_variable = { name = migration_main_t multiply = var:pop_calorie }
		change_variable = { name = migration_main_t subtract = 2 }
		change_variable = { name = migration_main_t divide = -2 }
		change_variable = { name = migration_main_t multiply = var:migration_main_t }
		
		if = {
			limit = {
				NOT = {
					has_variable = migration_tick
				}
			}
			set_variable = { name = migration_tick value = 0 }
		}
		
		change_variable = { name = migration_tick add = migration_main_t }
		
		set_variable = { name = migration_main_t value = var:pop_calorie }
		change_variable = { name = migration_main_t add = var:pop_nutrient }
		change_variable = { name = migration_main_t add = var:pop_comfort }
		change_variable = { name = migration_main_t add = var:pop_luxury }
		change_variable = { name = migration_main_t multiply = 25 }
		
		set_variable = { name = migration_route value = 0 }
	}
	
	every_province = {
		limit = {
			has_variable = migration_tick
			
			var:migration_tick >= 1
		}
		change_variable = { name = migration_tick multiply = var:pop_total }
		change_variable = { name = migration_tick divide = 100 }
		
		travel_distance_dijkstra_every = {
			start = this
			max = 540
			return_dist = migration_main_dist
			return_prev = migration_main_prev
			return_list = migration_main_list
		}
		
		save_temporary_scope_as = migration_main_t
		
		set_variable = { name = migration_main_tt value = 0 }
		
		every_in_global_list = {
			variable = migration_main_list
			
			if = {
				limit = {
					is_valid_prov = yes
					
					has_variable = migration_main_t
					
					var:migration_main_t > 0
					
					var:migration_main_t = {
						compare_value > scope:migration_main_t.var:migration_main_t
					}
				}
				set_variable = { name = migration_main_tt value = var:migration_main_t }
				change_variable = { name = migration_main_tt subtract = prev.var:migration_main_t }
				
				if = {
					limit = {
						NOT = {
							has_variable = migration_main_tttt
						}
					}
					sqrt_effect = {
						inp = var:pop_total
						return = migration_main_tttt
					}
				}
				
				change_variable = { name = migration_main_tt multiply = var:migration_main_tttt }
				
				set_variable = { name = migration_main_ttt value = var:migration_main_dist }
				change_variable = { name = migration_main_ttt divide = 60 }
				change_variable = { name = migration_main_ttt add = 1 }
				
				if = {
					limit = {
						county = scope:migration_main_t.county
					}
					change_variable = { name = migration_main_ttt divide = 2 }
					change_variable = { name = migration_main_ttt subtract = 0.1 }
				}
				else_if = {
					limit = {
						province_owner.top_liege = scope:migration_main_t.province_owner.top_liege
					}
					change_variable = { name = migration_main_ttt divide = 1.5 }
					change_variable = { name = migration_main_ttt subtract = 0.05 }
				}
				
				if = {
					limit = {
						culture = scope:migration_main_t.culture
					}
					change_variable = { name = migration_main_ttt divide = 2 }
					change_variable = { name = migration_main_ttt subtract = 0.1 }
				}
				else_if = {
					limit = {
						culture_group = scope:migration_main_t.culture_group
					}
					change_variable = { name = migration_main_ttt divide = 1.5 }
					change_variable = { name = migration_main_ttt subtract = 0.05 }
				}
				
				if = {
					limit = {
						OR = {
							religion != scope:migration_main_t.religion
							religion != scope:migration_main_t.province_owner.religion
						}
					}
					change_variable = { name = migration_main_ttt multiply = 2 }
					change_variable = { name = migration_main_ttt add = 0.1 }
				}
				
				change_variable = { name = migration_main_ttt add = 1 } 
				
				change_variable = { name = migration_main_tt divide = var:migration_main_ttt }
				
				prev = {
					change_variable = { name = migration_main_tt add = prev.var:migration_main_tt }
				}
			}
			else = {
				remove_list_global_variable = { name = migration_main_list target = this }
			}
		}
		
		if = {
			limit = {
				OR = {
					NOT = {
						has_variable = migration_main_tt
					}
					
					var:migration_main_tt = 0
				}
			}
			set_variable = { name = migration_tick value = 0 }
		}
		else = {
			every_in_global_list = {
				variable = migration_main_list
				
				change_variable = { name = migration_main_tt multiply = 100 }
				change_variable = { name = migration_main_tt divide = prev.var:migration_main_tt }
				change_variable = { name = migration_main_tt multiply = prev.var:migration_tick }
				change_variable = { name = migration_main_tt divide = 100 }
				
				change_variable = { name = pop_total add = var:migration_main_tt }
				
				prev = {
					change_variable = { name = pop_total subtract = prev.var:migration_main_tt }
				}
				
				save_temporary_scope_as = migration_main_t
				
				while = {
					limit = {
						scope:migration_main_t = {
							var:migration_main_prev != this
						}
					}
					scope:migration_main_t = {
						change_variable = { name = migration_route add = prev.var:migration_main_tt }
						
						var:migration_main_prev = {
							save_temporary_scope_as = migration_main_t
						}
					}
				}
			}
		}
		
		clear_global_variable_list = migration_main_list
	}
	
	every_province = {
		limit = {
			has_variable = migration_main_dist
		}
		remove_variable = migration_main_dist
		remove_variable = migration_main_prev
	}
	every_province = {
		limit = {
			is_valid_prov = yes
		}
		remove_variable = migration_main_t
		remove_variable = migration_main_tt
		remove_variable = migration_main_ttt
		remove_variable = migration_main_tttt
	}
}