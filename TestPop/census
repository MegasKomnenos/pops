namespace = census

census.01 = {
	type = empty
	hidden = yes
	
	immediate = {
		modi_refresh = yes
		
		prod_update_instances = yes
		
		forest_main = yes
	}
	
	option = {
	}
}

census.02 = {
	type = empty
	hidden = yes
	
	immediate = {
		mil_main_0 = yes
		stockpile_ai = yes
		
		if = {
			limit = {
				NOT = {
					has_global_variable = sim_i
				}
			}
			every_player = {
				stockpile_player = yes
			}
		}
	}
	
	option = {
	}
}

census.03 = {
	type = empty
	hidden = yes
	
	immediate = {
		task_main = yes
		task_ai = yes
		
		modi_refresh = yes
	}
	
	option = {
	}
}

census.04 = {
	type = empty
	hidden = yes
	
	immediate = {
		every_province = {
			limit = {
				is_valid_prov = yes
			}
			pop_update_demand = yes
		}
	}
	
	option = {
	}
}

census.05 = {
	type = empty
	hidden = yes
	
	immediate = {
		if = {
			limit = {
				OR = {
					NOT = {
						has_global_variable = trade_link_refresh
					}
					
					global_var:trade_link_refresh = 0
				}
			}
			set_global_variable = { name = trade_link_refresh value = 10 }
			
			trade_set_link = yes
		}
		else = {
			change_global_variable = { name = trade_link_refresh subtract = 1 }
		}
	}
	
	option = {
	}
}

census.06 = {
	type = empty
	hidden = yes
	
	immediate = {
		trade_do_trade = yes
	}
	
	option = {
	}
}

census.07 = {
	type = empty
	hidden = yes
	
	immediate = {
		trade_resolve_trade = yes
		trade_update_merchant = yes
		trade_update_price = yes
	}
	
	option = {
	}
}

census.08 = {
	type = empty
	hidden = yes
	
	immediate = {
		if = {
			limit = {
				has_global_variable_list = build_slots_active
					
				global_variable_list_size = { name = build_slots_active value >= 1}
			}
			every_in_global_list = {
				variable = build_slots_active
				
				build_update_project = yes
			}
		}
	}
	
	option = {
	}
}

census.09 = {
	type = empty
	hidden = yes
	
	immediate = {
		every_province = {
			limit = {
				is_valid_prov = yes
			}
			pop_resolve_demand = yes
		}
	}
	
	option = {
	}
}

census.10 = {
	type = empty
	hidden = yes
	
	immediate = {
		mil_main_1 = yes
		realm_update_obligation_base = yes
		
		every_province = {
			limit = {
				is_valid_prov = yes
				is_city = yes
			}
			if = {
				limit = {
					barony = {
						is_leased_out = no
						
						holder.primary_title.tier > tier_barony
					}
				}
				barony.holder = {
					add_to_global_variable_list = { name = census_t target = this }
					
					if = {
						limit = {
							is_independent_ruler = no
						}
						liege = {
							add_to_variable_list = { name = census_t target = prev }
						}
					}
				}
			}
		}
		
		while = {
			limit = {
				has_global_variable_list = census_t
				
				global_variable_list_size = { name = census_t value > 0 }
			}
			every_in_global_list = {
				limit = {
					OR = {
						NOT = {
							has_variable_list = census_t
						}
						NOT = {
							any_in_list = {
								variable = census_t
								
								is_target_in_global_variable_list = { name = census_t target = this }
							}
						}
					}
				}
				variable = census_t
				
				remove_list_global_variable = { name = census_t target = this }
				clear_variable_list = census_t
				
				realm_update = yes
			}
		}
		
		clear_global_variable_list = census_t
		
		realm_update_obligation = yes
		mil_main_2 = yes
		realm_ai = yes
	}
	
	option = {
	}
}

census.11 = {
	type = empty
	hidden = yes
	
	immediate = {
		stat_main = yes
	}
	
	option = {
	}
}

census.12 = {
	type = empty
	hidden = yes
	
	immediate = {
		every_province = {
			limit = {
				is_valid_prov = yes
			}
			set_variable = { name = pop_earn_base value = 4 }
			change_variable = { name = pop_earn_base subtract = var:pop_calorie }
			change_variable = { name = pop_earn_base subtract = var:pop_nutrient }
			change_variable = { name = pop_earn_base subtract = var:pop_comfort }
			change_variable = { name = pop_earn_base subtract = var:pop_luxury }
			change_variable = { name = pop_earn_base divide = 125 }
			change_variable = { name = pop_earn_base multiply = var:pop_total }
			
			change_variable = { name = pop_wealth add = var:pop_earn_free } 
			change_variable = { name = pop_wealth add = var:pop_earn_base } 
			change_variable = { name = pop_wealth subtract = var:pop_pay_free }
			
			if = {
				limit = {
					has_variable = realm_tax_pay
				}
				change_variable = { name = pop_wealth subtract = var:realm_tax_pay } 
			}
		}
		
		every_in_global_list = {
			variable = trade_merchants
			
			change_variable = { name = trade_wealth add = var:trade_earn }
			change_variable = { name = trade_wealth subtract = var:trade_pay }
			
			if = {
				limit = {
					OR = {
						NOT = {
							has_variable = trade_wealth
						}
						
						var:trade_wealth <= 0
					}
				}
				set_variable = { name = trade_wealth value = 0 }
			}
		}
		
		every_ruler = {
			limit = {
				is_character = yes
				is_landed = yes
			}
			set_variable = { name = census_t value = 0 }
			
			if = { limit = { has_variable = trade_earn } change_variable = { name = census_t add = var:trade_earn } }
			if = { limit = { has_variable = trade_pay } change_variable = { name = census_t subtract = var:trade_pay } }
			
			if = {
				limit = {
					has_variable = census_t
					
					var:census_t > 0
				}
				eff_binary_1_16 = { name = census_t eff = add_gold }
			}
			else = {
				change_variable = { name = census_t multiply = -1 }
				
				eff_binary_1_16 = { name = census_t eff = remove_short_term_gold }
			}

			remove_variable = census_t
		}
	}
	
	option = {
	}
}

census.13 = {
	type = empty
	hidden = yes
	
	immediate = {
	}
	
	option = {
	}
}

census.99 = {
	type = empty
	hidden = yes
	
	immediate = {
		setup_rulers = yes	
	}
	
	option = {
	}
}